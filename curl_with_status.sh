#!/usr/bin/env bash
# Comandi cURL con status code per validare al volo
# Sostituisci <HOST>, <SESSION_ID>, <MANUS_WEBHOOK_SECRET_REALE> con i tuoi valori

echo "‚ö° CURL CON STATUS CODE PER VALIDARE AL VOLO"
echo "============================================"
echo "Sostituisci <HOST>, <SESSION_ID>, <MANUS_WEBHOOK_SECRET_REALE> con i tuoi valori"
echo ""

echo "1Ô∏è‚É£ Health GET + HEAD:"
echo "======================"
echo "curl -sS https://<HOST>/webhooks/manus/hooks/health -w \" ‚Üí %{http_code}\n\""
echo "curl -sS -I https://<HOST>/webhooks/manus/hooks/health -w \" ‚Üí %{http_code}\n\" | head -n1"
echo ""

echo "2Ô∏è‚É£ Admin senza auth (negativo):"
echo "================================"
echo "curl -sS -X POST https://<HOST>/admin/manus/mapping/create \\"
echo "  -H \"Content-Type: application/json\" \\"
echo "  -d '{\"manus_user_id\":\"u_test\",\"syn_user_id\":42,\"email\":\"test@example.com\"}' \\"
echo "  -w \" ‚Üí %{http_code}\n\""
echo ""

echo "3Ô∏è‚É£ Admin con auth (positivo):"
echo "=============================="
echo "curl -sS -X POST https://<HOST>/admin/manus/mapping/create \\"
echo "  -H \"Content-Type: application/json\" \\"
echo "  -H \"Cookie: session=<SESSION_ID>\" \\"
echo "  -d '{\"manus_user_id\":\"u_test\",\"syn_user_id\":42,\"email\":\"test@example.com\"}' \\"
echo "  -w \" ‚Üí %{http_code}\n\""
echo ""

echo "4Ô∏è‚É£ Webhook firma sbagliata (negativo):"
echo "======================================"
echo "BAD_SIG=deadbeef"
echo "BODY='{\"course_id\":\"COURSE123\",\"manus_user_id\":\"u_test\",\"email\":\"test@example.com\"}'"
echo "curl -sS -X POST https://<HOST>/webhooks/manus/hooks \\"
echo "  -H \"X-Manus-Event: COURSE_COMPLETED\" \\"
echo "  -H \"X-Manus-Signature: \$BAD_SIG\" \\"
echo "  -H \"Content-Type: application/json\" \\"
echo "  -d \"\$BODY\" \\"
echo "  -w \" ‚Üí %{http_code}\n\""
echo ""

echo "5Ô∏è‚É£ Webhook firma corretta (positivo):"
echo "====================================="
echo "SECRET='<MANUS_WEBHOOK_SECRET_REALE>'"
echo "BODY='{\"course_id\":\"COURSE123\",\"manus_user_id\":\"u_test\",\"email\":\"test@example.com\"}'"
echo "SIG=\$(printf \"%s\" \"\$BODY\" | openssl dgst -sha256 -hmac \"\$SECRET\" -r | awk '{print \$1}')"
echo "curl -sS -X POST https://<HOST>/webhooks/manus/hooks \\"
echo "  -H \"X-Manus-Event: COURSE_COMPLETED\" \\"
echo "  -H \"X-Manus-Signature: \$SIG\" \\"
echo "  -H \"Content-Type: application/json\" \\"
echo "  -d \"\$BODY\" \\"
echo "  -w \" ‚Üí %{http_code}\n\""
echo ""

echo "6Ô∏è‚É£ Coverage rebuild:"
echo "===================="
echo "curl -sS -X POST https://<HOST>/admin/manus/coverage/rebuild/42 \\"
echo "  -H \"Cookie: session=<SESSION_ID>\" \\"
echo "  -w \" ‚Üí %{http_code}\n\""
echo ""

echo "üîç Verifiche DB rapide (opzionali):"
echo "==================================="
echo "sqlite3 gestione.db 'SELECT COUNT(*) FROM manus_user_mapping;'"
echo "sqlite3 gestione.db 'SELECT COUNT(*) FROM training_coverage_report;'"
echo ""

echo "üìä Risultati attesi:"
echo "===================="
echo "‚Ä¢ Health GET/HEAD: ‚Üí 200"
echo "‚Ä¢ Admin senza auth: ‚Üí 401/403"
echo "‚Ä¢ Admin con auth: ‚Üí 200"
echo "‚Ä¢ Webhook firma sbagliata: ‚Üí 401"
echo "‚Ä¢ Webhook firma corretta: ‚Üí 200"
echo "‚Ä¢ Coverage rebuild: ‚Üí 200"
echo ""

echo "üö® Troubleshooting rapido:"
echo "=========================="
echo "‚Ä¢ 401/403 su admin ‚Üí manca Cookie/Token"
echo "‚Ä¢ 401 su webhook ‚Üí secret/firma: ricalcola SIG dal body identico"
echo "‚Ä¢ 200 ma coverage invariato ‚Üí crea mapping (test 3) ‚Üí rifai rebuild (test 6)"
echo "‚Ä¢ Timeout/504 ‚Üí journalctl -u gunicorn -n 80 --no-pager e riprova"

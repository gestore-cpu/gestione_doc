<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Amministratore - Mercury</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      background: #f8f9fa;
      font-family: 'Segoe UI', sans-serif;
    }
    .sidebar {
      height: 100vh;
      position: fixed;
      width: 220px;
      background-color: #0d6efd;
      color: white;
      padding-top: 1rem;
    }
    .sidebar a {
      color: white;
      text-decoration: none;
      padding: 0.75rem 1.5rem;
      display: block;
    }
    .sidebar a:hover, .sidebar a.active {
      background-color: #0b5ed7;
    }
    main {
      margin-left: 220px;
      padding: 2rem;
    }
    .table thead {
      background-color: #0d6efd;
      color: white;
    }
    .section-title {
      border-bottom: 2px solid #0d6efd;
      padding-bottom: 0.3rem;
      margin-bottom: 1rem;
      color: #0d6efd;
      font-weight: 600;
    }
    .chart-container {
      max-width: 700px;
      margin-top: 2rem;
    }
  </style>
</head>
<body>

  <nav class="sidebar">
    <h4 class="text-center mb-4">Mercury Admin</h4>
    <a href="#dashboard" class="active"><i class="fa fa-chart-line me-2"></i>Dashboard</a>
    <a href="#users"><i class="fa fa-users me-2"></i>Gestione Utenti</a>
    <a href="#companies"><i class="fa fa-building me-2"></i>Aziende</a>
    <a href="#departments"><i class="fa fa-sitemap me-2"></i>Reparti</a>
    <a href="#documents"><i class="fa fa-file-alt me-2"></i>Documenti</a>
    <a href="{{ url_for('admin.ai_insights') }}"><i class="fa fa-robot me-2"></i>AI Documentale</a>
    <a href="{{ url_for('admin.ai_tasks') }}"><i class="fa fa-tasks me-2"></i>Task AI</a>
    <a href="{{ url_for('admin.security_alerts') }}"><i class="fa fa-shield-alt me-2"></i>Security Alerts</a>
    <a href="#secure-data"><i class="fa fa-lock me-2"></i>Password Sicure</a>
    <a href="#logs"><i class="fa fa-clipboard-list me-2"></i>Log Attività</a>
    <a href="{{ url_for('auth.logout') }}"><i class="fa fa-sign-out-alt me-2"></i>Logout</a>
  </nav>

  <main>
    <section id="dashboard">
      <h2 class="section-title">Dashboard</h2>
      <div class="row gy-4">
        <div class="col-md-3">
          <div class="card text-white bg-primary">
            <div class="card-body">
              <h5 class="card-title">Utenti Totali</h5>
              <p class="card-text fs-3">{{ utenti|length }}</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-white bg-success">
            <div class="card-body">
              <h5 class="card-title">Documenti Caricati</h5>
              <p class="card-text fs-3">{{ documenti|length if documenti is iterable else documenti }}</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-white bg-info">
            <div class="card-body">
              <h5 class="card-title">Aziende</h5>
              <p class="card-text fs-3">{{ aziende|length }}</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-white bg-warning">
            <div class="card-body">
              <h5 class="card-title">Reparti</h5>
              <p class="card-text fs-3">{{ reparti|length }}</p>
            </div>
          </div>
        </div>
      </div>

      <div class="chart-container">
        <canvas id="activityChart" height="150"></canvas>
      </div>
    </section>

    <section id="users" class="mt-5">
      <h2 class="section-title">Gestione Utenti</h2>
      <a href="{{ url_for('admin_create_user') }}" class="btn btn-primary mb-3"><i class="fa fa-plus"></i> Crea Nuovo Utente</a>
      <div class="table-responsive">
        <table class="table table-striped table-bordered align-middle">
          <thead>
            <tr>
              <th>ID</th>
              <th>Username</th>
              <th>Email</th>
              <th>Azienda</th>
              <th>Reparto</th>
              <th>Admin</th>
              <th>Azioni</th>
            </tr>
          </thead>
          <tbody>
            {% for u in utenti %}
            <tr>
              <td>{{ u.id }}</td>
              <td>{{ u.username }}</td>
              <td>{{ u.email }}</td>
              <td>{{ u.company.name if u.company else '-' }}</td>
              <td>{{ u.department.name if u.department else '-' }}</td>
              <td>{{ 'Sì' if u.is_admin else 'No' }}</td>
              <td>
                <a href="{{ url_for('admin_edit_user', user_id=u.id) }}" class="btn btn-sm btn-warning"><i class="fa fa-edit"></i> Modifica</a>
              </td>
            </tr>
            {% else %}
            <tr><td colspan="7" class="text-center">Nessun utente registrato.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

    <section id="companies" class="mt-5">
      <h2 class="section-title">Gestione Aziende</h2>
      <a href="{{ url_for('admin_companies') }}" class="btn btn-primary mb-3"><i class="fa fa-building"></i> Gestisci Aziende</a>
    </section>

    <section id="departments" class="mt-5">
      <h2 class="section-title">Gestione Reparti</h2>
      <a href="{{ url_for('admin_departments') }}" class="btn btn-primary mb-3"><i class="fa fa-sitemap"></i> Gestisci Reparti</a>
    </section>

    <section id="documents" class="mt-5">
      <h2 class="section-title">Documenti</h2>
      <div class="table-responsive">
        <table class="table table-striped table-bordered align-middle">
          <thead>
            <tr>
              <th>ID</th>
              <th>Titolo</th>
              <th>Uploader</th>
              <th>Azienda</th>
              <th>Reparto</th>
              <th>Visibilità</th>
              <th>Data Caricamento</th>
              <th>Azioni</th>
            </tr>
          </thead>
          <tbody>
            {% for d in documenti %}
            <tr>
              <td>{{ d.id }}</td>
              <td>{{ d.title }}</td>
              <td>{{ d.uploaded_by }}</td>
              <td>{{ d.company }}</td>
              <td>{{ d.department }}</td>
              <td>{{ d.visibility }}</td>
              <td>{{ d.upload_date.strftime('%d/%m/%Y') }}</td>
              <td>
                <a href="{{ url_for('view_document', document_id=d.id) }}" class="btn btn-sm btn-info" target="_blank"><i class="fa fa-eye"></i></a>
                <a href="{{ url_for('edit_document_permissions', document_id=d.id) }}" class="btn btn-sm btn-warning"><i class="fa fa-lock"></i></a>
              </td>
            </tr>
            {% else %}
            <tr><td colspan="8" class="text-center">Nessun documento trovato.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

    <section id="secure-data" class="mt-5">
      <h2 class="section-title">Password Sicure e Link Riservati</h2>
      <a href="{{ url_for('admin_secure_data') }}" class="btn btn-primary mb-3"><i class="fa fa-key"></i> Gestisci Password e Link</a>
      <!-- Puoi aggiungere riepilogo o elenco rapido qui -->
    </section>

    <section id="logs" class="mt-5">
      <h2 class="section-title">Log Attività</h2>
      <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
        <table class="table table-striped table-bordered align-middle">
          <thead>
            <tr>
              <th>ID</th>
              <th>Data / Ora</th>
              <th>Azione</th>
              <th>Utente</th>
              <th>Documento ID</th>
              <th>Info Extra</th>
            </tr>
          </thead>
          <tbody>
            {% for log in log_admin %}
            <tr>
              <td>{{ log.id }}</td>
              <td>{{ log.timestamp.strftime('%d/%m/%Y %H:%M:%S') }}</td>
              <td>{{ log.action }}</td>
              <td>{{ log.performed_by }}</td>
              <td>{{ log.document_id or '-' }}</td>
              <td>{{ log.extra_info or '-' }}</td>
            </tr>
            {% else %}
            <tr><td colspan="6" class="text-center">Nessun log disponibile.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    // Grafico attività (esempio statico, sostituisci con dati dinamici via API se vuoi)
    const ctx = document.getElementById('activityChart').getContext('2d');
    const activityChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab', 'Dom'],
        datasets: [{
          label: 'Upload',
          data: [12, 19, 3, 5, 2, 3, 7],
          backgroundColor: '#0d6efd'
        }, {
          label: 'Download',
          data: [2, 3, 20, 5, 1, 4, 8],
          backgroundColor: '#198754'
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'top' },
          title: { display: true, text: 'Attività ultimi 7 giorni' }
        }
      }
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

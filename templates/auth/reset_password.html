{% extends "base.html" %}

{% block title %}Reset Password{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-4">
            <div class="card shadow-lg">
                <div class="card-header bg-success text-white text-center">
                    <h4 class="mb-0">
                        <i class="fas fa-key"></i> üîë Nuova Password
                    </h4>
                </div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        <i class="fas fa-user fa-3x text-muted"></i>
                        <p class="text-muted mt-2">
                            Imposta una nuova password per <strong>{{ email }}</strong>
                        </p>
                    </div>
                    
                    <form method="POST">
                        <div class="mb-3">
                            <label for="password" class="form-label">
                                <i class="fas fa-lock"></i> Nuova Password
                            </label>
                            <input type="password" 
                                   class="form-control" 
                                   id="password" 
                                   name="password" 
                                   placeholder="Inserisci la nuova password"
                                   required 
                                   autocomplete="new-password">
                            <div class="form-text">
                                Minimo 8 caratteri con maiuscole, minuscole, numeri e simboli
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="confirm" class="form-label">
                                <i class="fas fa-lock"></i> Conferma Password
                            </label>
                            <input type="password" 
                                   class="form-control" 
                                   id="confirm" 
                                   name="confirm" 
                                   placeholder="Conferma la nuova password"
                                   required 
                                   autocomplete="new-password">
                        </div>
                        
                        <!-- Indicatore forza password -->
                        <div class="mb-3">
                            <label class="form-label">Forza Password:</label>
                            <div class="progress mb-2" style="height: 8px;">
                                <div class="progress-bar" id="password-strength" role="progressbar" style="width: 0%"></div>
                            </div>
                            <small class="text-muted" id="password-feedback">Inizia a digitare per vedere la forza della password</small>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success" id="submit-btn" disabled>
                                <i class="fas fa-save"></i> üîÅ Reimposta Password
                            </button>
                        </div>
                    </form>
                    
                    <hr class="my-4">
                    
                    <div class="text-center">
                        <a href="{{ url_for('auth.login') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left"></i> Torna al Login
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Requisiti password -->
            <div class="card mt-3 border-warning">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0">
                        <i class="fas fa-shield-alt"></i> Requisiti Sicurezza
                    </h6>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0" id="requirements-list">
                        <li id="req-length"><i class="fas fa-times text-danger"></i> Almeno 8 caratteri</li>
                        <li id="req-uppercase"><i class="fas fa-times text-danger"></i> Almeno una lettera maiuscola</li>
                        <li id="req-lowercase"><i class="fas fa-times text-danger"></i> Almeno una lettera minuscola</li>
                        <li id="req-number"><i class="fas fa-times text-danger"></i> Almeno un numero</li>
                        <li id="req-special"><i class="fas fa-times text-danger"></i> Almeno un carattere speciale</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const passwordInput = document.getElementById('password');
    const confirmInput = document.getElementById('confirm');
    const submitBtn = document.getElementById('submit-btn');
    const strengthBar = document.getElementById('password-strength');
    const feedback = document.getElementById('password-feedback');
    
    // Funzione per validare la password
    function validatePassword(password) {
        const requirements = {
            length: password.length >= 8,
            uppercase: /[A-Z]/.test(password),
            lowercase: /[a-z]/.test(password),
            number: /\d/.test(password),
            special: /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)
        };
        
        // Aggiorna indicatori requisiti
        document.getElementById('req-length').innerHTML = 
            `<i class="fas fa-${requirements.length ? 'check text-success' : 'times text-danger'}"></i> Almeno 8 caratteri`;
        
        document.getElementById('req-uppercase').innerHTML = 
            `<i class="fas fa-${requirements.uppercase ? 'check text-success' : 'times text-danger'}"></i> Almeno una lettera maiuscola`;
        
        document.getElementById('req-lowercase').innerHTML = 
            `<i class="fas fa-${requirements.lowercase ? 'check text-success' : 'times text-danger'}"></i> Almeno una lettera minuscola`;
        
        document.getElementById('req-number').innerHTML = 
            `<i class="fas fa-${requirements.number ? 'check text-success' : 'times text-danger'}"></i> Almeno un numero`;
        
        document.getElementById('req-special').innerHTML = 
            `<i class="fas fa-${requirements.special ? 'check text-success' : 'times text-danger'}"></i> Almeno un carattere speciale`;
        
        // Calcola punteggio forza
        const score = Object.values(requirements).filter(Boolean).length;
        const percentage = (score / 5) * 100;
        
        // Aggiorna barra di forza
        strengthBar.style.width = percentage + '%';
        
        if (score <= 2) {
            strengthBar.className = 'progress-bar bg-danger';
            feedback.textContent = 'Password molto debole';
        } else if (score <= 3) {
            strengthBar.className = 'progress-bar bg-warning';
            feedback.textContent = 'Password debole';
        } else if (score <= 4) {
            strengthBar.className = 'progress-bar bg-info';
            feedback.textContent = 'Password media';
        } else {
            strengthBar.className = 'progress-bar bg-success';
            feedback.textContent = 'Password forte';
        }
        
        return score === 5; // Tutti i requisiti soddisfatti
    }
    
    // Funzione per validare conferma
    function validateConfirm() {
        const password = passwordInput.value;
        const confirm = confirmInput.value;
        
        if (confirm && password !== confirm) {
            confirmInput.classList.add('is-invalid');
            return false;
        } else {
            confirmInput.classList.remove('is-invalid');
            return true;
        }
    }
    
    // Event listeners
    passwordInput.addEventListener('input', function() {
        const isValid = validatePassword(this.value);
        const confirmValid = validateConfirm();
        submitBtn.disabled = !(isValid && confirmValid);
    });
    
    confirmInput.addEventListener('input', function() {
        const passwordValid = validatePassword(passwordInput.value);
        const confirmValid = validateConfirm();
        submitBtn.disabled = !(passwordValid && confirmValid);
    });
    
    // Validazione form
    document.querySelector('form').addEventListener('submit', function(e) {
        const password = passwordInput.value;
        const confirm = confirmInput.value;
        
        if (!validatePassword(password)) {
            e.preventDefault();
            alert('La password non soddisfa tutti i requisiti di sicurezza.');
            return false;
        }
        
        if (password !== confirm) {
            e.preventDefault();
            alert('Le password non coincidono.');
            return false;
        }
    });
});
</script>

<style>
.card {
    border-radius: 15px;
    border: none;
}

.card-header {
    border-radius: 15px 15px 0 0 !important;
}

.btn {
    border-radius: 8px;
    font-weight: 500;
}

.form-control {
    border-radius: 8px;
    border: 2px solid #e9ecef;
    transition: border-color 0.3s ease;
}

.form-control:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.form-control.is-invalid {
    border-color: #dc3545;
}

.progress {
    border-radius: 10px;
}

.progress-bar {
    transition: width 0.3s ease;
}

.fa-3x {
    color: #6c757d;
}

.list-unstyled li {
    margin-bottom: 0.5rem;
}

.list-unstyled li i {
    margin-right: 0.5rem;
}
</style>
{% endblock %}

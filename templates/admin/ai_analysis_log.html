<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß† Registro Storico Analisi AI - Dashboard Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .card-stats {
            transition: transform 0.2s;
        }
        .card-stats:hover {
            transform: translateY(-2px);
        }
        .badge-ai {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
        }
        .table-responsive {
            max-height: 600px;
            overflow-y: auto;
        }
        .filter-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .log-row {
            transition: background-color 0.2s;
        }
        .log-row:hover {
            background-color: #f8f9fa;
        }
        .action-badge {
            font-size: 0.8em;
            padding: 4px 8px;
        }
        .payload-preview {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container-fluid">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="h3 mb-0">
                            <i class="fas fa-brain text-primary"></i>
                            Registro Storico Analisi AI
                        </h1>
                        <p class="text-muted mb-0">Tracciamento completo delle azioni AI sui documenti</p>
                    </div>
                    <div>
                        <a href="{{ url_for('admin.export_ai_analysis_log') }}" class="btn btn-outline-success">
                            <i class="fas fa-download"></i> Esporta CSV
                        </a>
                        <a href="{{ url_for('admin.admin_dashboard') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left"></i> Torna alla Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistiche Card -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card card-stats bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="card-title mb-0">{{ total_logs }}</h4>
                                <p class="card-text">üìä Analisi Totali</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-chart-line fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card card-stats bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="card-title mb-0">{{ accepted_logs }}</h4>
                                <p class="card-text">‚úÖ Accettate</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-check-circle fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card card-stats bg-warning text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="card-title mb-0">{{ rejected_logs }}</h4>
                                <p class="card-text">‚ùå Rifiutate</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-times-circle fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card card-stats bg-info text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="card-title mb-0">{{ action_counts|length }}</h4>
                                <p class="card-text">üéØ Tipi di Azione</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-tags fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtri -->
        <div class="filter-section">
            <h5 class="mb-3">
                <i class="fas fa-filter"></i>
                Filtri Avanzati
            </h5>
            <form method="GET" class="row g-3">
                <div class="col-md-2">
                    <label for="document_id" class="form-label">Documento</label>
                    <select name="document_id" id="document_id" class="form-select">
                        <option value="">üìÑ Tutti i documenti</option>
                        {% for doc in documents %}
                        <option value="{{ doc.id }}" {% if filters.document_id == doc.id %}selected{% endif %}>
                            {{ doc.title[:50] }}{% if doc.title|length > 50 %}...{% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="action_type" class="form-label">Tipo Azione</label>
                    <select name="action_type" id="action_type" class="form-select">
                        <option value="">üéØ Tutti i tipi</option>
                        <option value="tag_suggerito" {% if filters.action_type == 'tag_suggerito' %}selected{% endif %}>
                            üè∑Ô∏è Tag Suggerito
                        </option>
                        <option value="task_generato" {% if filters.action_type == 'task_generato' %}selected{% endif %}>
                            üìã Task Generato
                        </option>
                        <option value="alert_ai" {% if filters.action_type == 'alert_ai' %}selected{% endif %}>
                            ‚ö†Ô∏è Alert AI
                        </option>
                        <option value="classificazione_ai" {% if filters.action_type == 'classificazione_ai' %}selected{% endif %}>
                            üß† Classificazione AI
                        </option>
                        <option value="ricerca_semantica" {% if filters.action_type == 'ricerca_semantica' %}selected{% endif %}>
                            üîç Ricerca Semantica
                        </option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="date_from" class="form-label">Data Da</label>
                    <input type="date" name="date_from" id="date_from" class="form-control" 
                           value="{{ filters.date_from }}">
                </div>
                <div class="col-md-2">
                    <label for="date_to" class="form-label">Data A</label>
                    <input type="date" name="date_to" id="date_to" class="form-control" 
                           value="{{ filters.date_to }}">
                </div>
                <div class="col-md-2">
                    <label for="accepted_only" class="form-label">Stato</label>
                    <select name="accepted_only" id="accepted_only" class="form-select">
                        <option value="false" {% if not filters.accepted_only %}selected{% endif %}>
                            üìä Tutti
                        </option>
                        <option value="true" {% if filters.accepted_only %}selected{% endif %}>
                            ‚úÖ Solo Accettate
                        </option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search"></i> Filtra
                        </button>
                    </div>
                </div>
            </form>
            <div class="mt-3">
                <a href="{{ url_for('admin.ai_analysis_log') }}" class="btn btn-outline-secondary btn-sm">
                    <i class="fas fa-times"></i> Reset Filtri
                </a>
            </div>
        </div>

        <!-- Grafico Distribuzione Azioni -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-pie"></i>
                            Distribuzione per Tipo di Azione
                        </h5>
                    </div>
                    <div class="card-body">
                        <canvas id="actionChart" height="200"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-bar"></i>
                            Statistiche Accettazione
                        </h5>
                    </div>
                    <div class="card-body">
                        <canvas id="acceptanceChart" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabella Log -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-list"></i>
                    Storico Analisi AI ({{ logs|length }} record)
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>üìÑ Documento</th>
                                <th>üéØ Tipo Azione</th>
                                <th>üìù Payload</th>
                                <th>‚è∞ Timestamp</th>
                                <th>‚úÖ Stato</th>
                                <th>üë§ Utente</th>
                                <th>üîç Azioni</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for log in logs %}
                            <tr class="log-row">
                                <td>
                                    <span class="badge bg-secondary">{{ log.id }}</span>
                                </td>
                                <td>
                                    <strong>{{ log.document.title if log.document else 'N/A' }}</strong>
                                    {% if log.document %}
                                    <br><small class="text-muted">ID: {{ log.document.id }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge badge-ai action-badge">
                                        {{ log.action_display }}
                                    </span>
                                </td>
                                <td>
                                    <div class="payload-preview" title="{{ log.payload or 'N/A' }}">
                                        {{ log.payload[:100] + '...' if log.payload and log.payload|length > 100 else log.payload or 'N/A' }}
                                    </div>
                                </td>
                                <td>
                                    <small>{{ log.timestamp.strftime('%d/%m/%Y %H:%M') }}</small>
                                </td>
                                <td>
                                    {% if log.accepted_by_user %}
                                    <span class="badge bg-success">
                                        <i class="fas fa-check"></i> Accettato
                                    </span>
                                    {% else %}
                                    <span class="badge bg-warning">
                                        <i class="fas fa-clock"></i> In Attesa
                                    </span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if log.user %}
                                    <small>{{ log.user.full_name }}</small>
                                    {% else %}
                                    <small class="text-muted">N/A</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-info btn-sm" 
                                                onclick="viewLogDetails({{ log.id }})" 
                                                title="Visualizza Dettagli">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        {% if not log.accepted_by_user %}
                                        <button type="button" class="btn btn-outline-success btn-sm" 
                                                onclick="acceptLog({{ log.id }})" 
                                                title="Accetta">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-danger btn-sm" 
                                                onclick="rejectLog({{ log.id }})" 
                                                title="Rifiuta">
                                            <i class="fas fa-times"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="8" class="text-center py-4">
                                    <div class="text-muted">
                                        <i class="fas fa-inbox fa-3x mb-3"></i>
                                        <p>Nessun log di analisi AI trovato</p>
                                        <small>I log appariranno qui quando l'AI analizzer√† i documenti</small>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Dettagli Log -->
    <div class="modal fade" id="logDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-info-circle"></i>
                        Dettagli Analisi AI
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="logDetailsContent">
                    <!-- Contenuto dinamico -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Dati per i grafici
        const actionData = {
            labels: {{ action_counts.keys() | list | tojson }},
            datasets: [{
                data: {{ action_counts.values() | list | tojson }},
                backgroundColor: [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                    '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
                ]
            }]
        };

        const acceptanceData = {
            labels: ['Accettate', 'In Attesa'],
            datasets: [{
                data: [{{ accepted_logs }}, {{ rejected_logs }}],
                backgroundColor: ['#28a745', '#ffc107']
            }]
        };

        // Grafico distribuzione azioni
        new Chart(document.getElementById('actionChart'), {
            type: 'doughnut',
            data: actionData,
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });

        // Grafico accettazione
        new Chart(document.getElementById('acceptanceChart'), {
            type: 'bar',
            data: acceptanceData,
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Funzioni per gestione log
        function viewLogDetails(logId) {
            // Simula caricamento dettagli
            document.getElementById('logDetailsContent').innerHTML = 
                '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Caricamento...</div>';
            
            // Qui andrebbe una chiamata AJAX per caricare i dettagli
            setTimeout(() => {
                document.getElementById('logDetailsContent').innerHTML = 
                    '<p>Dettagli del log ID: ' + logId + '</p>' +
                    '<p>Funzionalit√† in sviluppo...</p>';
            }, 500);
            
            new bootstrap.Modal(document.getElementById('logDetailsModal')).show();
        }

        function acceptLog(logId) {
            if (confirm('Confermi di accettare questa analisi AI?')) {
                // Qui andrebbe una chiamata AJAX per accettare il log
                alert('Funzionalit√† in sviluppo...');
            }
        }

        function rejectLog(logId) {
            if (confirm('Confermi di rifiutare questa analisi AI?')) {
                // Qui andrebbe una chiamata AJAX per rifiutare il log
                alert('Funzionalit√† in sviluppo...');
            }
        }

        // Auto-refresh ogni 30 secondi
        setInterval(() => {
            location.reload();
        }, 30000);
    </script>
</body>
</html> 
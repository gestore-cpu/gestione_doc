<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Versioni Documento - Gestione Documenti</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
          <i class="fas fa-history text-primary"></i> 
          Versioni Documento: {{ document.title }}
        </h2>
        <a href="{{ url_for('admin.view_document', document_id=document.id) }}" class="btn btn-outline-secondary">
          <i class="fas fa-arrow-left"></i> Torna al Documento
        </a>
      </div>

      <!-- Informazioni documento -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-file-alt"></i> 
            Informazioni Documento
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <p><strong>Titolo:</strong> {{ document.title }}</p>
              <p><strong>Filename:</strong> {{ document.filename }}</p>
              <p><strong>Categoria:</strong> {{ document.categoria_ai or "Non specificata" }}</p>
            </div>
            <div class="col-md-6">
              <p><strong>Uploader:</strong> {{ document.uploader_email }}</p>
              <p><strong>Data creazione:</strong> {{ document.created_at.strftime('%d/%m/%Y %H:%M') if document.created_at else 'N/A' }}</p>
              <p><strong>Stato:</strong> 
                {% if document.validazione_admin and document.validazione_ceo %}
                  <span class="badge bg-success">‚úÖ Approvato</span>
                {% else %}
                  <span class="badge bg-warning">‚è≥ In attesa</span>
                {% endif %}
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Statistiche versioni -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="card bg-primary text-white">
            <div class="card-body text-center">
              <h5 class="card-title">üìÑ Totali</h5>
              <h3>{{ versioni|length }}</h3>
              <small>Versioni</small>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-success text-white">
            <div class="card-body text-center">
              <h5 class="card-title">‚úÖ Attiva</h5>
              <h3>{{ versioni|selectattr('is_active', 'equalto', true)|list|length }}</h3>
              <small>Versione corrente</small>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-info text-white">
            <div class="card-body text-center">
              <h5 class="card-title">üìÖ Ultima</h5>
              <h3>{{ versioni[0].uploaded_at.strftime('%d/%m') if versioni else 'N/A' }}</h3>
              <small>Aggiornamento</small>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-warning text-dark">
            <div class="card-body text-center">
              <h5 class="card-title">üë§ Autori</h5>
              <h3>{{ versioni|map(attribute='user.username')|unique|list|length }}</h3>
              <small>Utenti diversi</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Lista versioni -->
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="fas fa-list"></i> 
            Storico Versioni
          </h5>
          <div class="btn-group">
            <button class="btn btn-outline-primary btn-sm" onclick="exportVersioni()">
              <i class="fas fa-download"></i> Esporta
            </button>
            <button class="btn btn-outline-info btn-sm" onclick="showVersionComparison()">
              <i class="fas fa-balance-scale"></i> Confronta
            </button>
          </div>
        </div>
        <div class="card-body">
          {% if versioni %}
            <div class="table-responsive">
              <table class="table table-hover">
                <thead class="table-light">
                  <tr>
                    <th>üìÑ Versione</th>
                    <th>üìÖ Data</th>
                    <th>üë§ Autore</th>
                    <th>üìè Dimensione</th>
                    <th>üìù Note</th>
                    <th>üìä Stato</th>
                    <th>üîß Azioni</th>
                  </tr>
                </thead>
                <tbody>
                  {% for versione in versioni %}
                    <tr class="{% if versione.is_active %}table-success{% endif %}">
                      <td>
                        <strong>v{{ versione.version_number }}</strong>
                        <br><small class="text-muted">{{ versione.filename }}</small>
                      </td>
                      <td>
                        {{ versione.uploaded_at_formatted }}
                        <br><small class="text-muted">{{ versione.uploaded_at.strftime('%H:%M') }}</small>
                      </td>
                      <td>
                        <strong>{{ versione.user.username }}</strong>
                        <br><small class="text-muted">{{ versione.user.email }}</small>
                      </td>
                      <td>
                        <span class="badge bg-secondary">{{ versione.file_size }} MB</span>
                      </td>
                      <td>
                        {% if versione.note %}
                          <small class="text-muted">{{ versione.note[:50] }}{% if versione.note|length > 50 %}...{% endif %}</small>
                        {% else %}
                          <span class="text-muted">-</span>
                        {% endif %}
                      </td>
                      <td>
                        {% if versione.is_active %}
                          <span class="badge bg-success">‚úÖ Attiva</span>
                        {% else %}
                          <span class="badge bg-secondary">üìÑ Storico</span>
                        {% endif %}
                      </td>
                      <td>
                        <div class="btn-group btn-group-sm">
                          <a href="{{ url_for('docs.download_versione', version_id=versione.id) }}" 
                             class="btn btn-outline-primary" title="Download">
                            <i class="fas fa-download"></i>
                          </a>
                          {% if not versione.is_active %}
                            <button class="btn btn-outline-warning" 
                                    onclick="ripristinaVersione({{ versione.id }})" 
                                    title="Ripristina">
                              <i class="fas fa-undo"></i>
                            </button>
                          {% endif %}
                          <button class="btn btn-outline-info" 
                                  onclick="showVersionDetails({{ versione.id }})" 
                                  title="Dettagli">
                            <i class="fas fa-info-circle"></i>
                          </button>
                          {% if not versione.is_active %}
                            <button class="btn btn-outline-danger" 
                                    onclick="eliminaVersione({{ versione.id }})" 
                                    title="Elimina">
                              <i class="fas fa-trash"></i>
                            </button>
                          {% endif %}
                        </div>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="text-center py-4">
              <i class="fas fa-history fa-3x text-muted mb-3"></i>
              <h5 class="text-muted">Nessuna versione trovata</h5>
              <p class="text-muted">
                Questo documento non ha ancora versioni storiche.
              </p>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Timeline versioni -->
      {% if versioni|length > 1 %}
        <div class="card mt-4">
          <div class="card-header">
            <h6 class="mb-0">
              <i class="fas fa-timeline"></i> 
              Timeline Versioni
            </h6>
          </div>
          <div class="card-body">
            <div class="timeline">
              {% for versione in versioni %}
                <div class="timeline-item {% if versione.is_active %}active{% endif %}">
                  <div class="timeline-marker {% if versione.is_active %}bg-success{% else %}bg-secondary{% endif %}">
                    <i class="fas fa-file"></i>
                  </div>
                  <div class="timeline-content">
                    <h6 class="mb-1">v{{ versione.version_number }} - {{ versione.filename }}</h6>
                    <p class="mb-1 text-muted">
                      {{ versione.uploaded_at_formatted }} da {{ versione.user.username }}
                    </p>
                    {% if versione.note %}
                      <small class="text-muted">{{ versione.note }}</small>
                    {% endif %}
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Modal dettagli versione -->
<div class="modal fade" id="versionModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Dettagli Versione</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="versionModalBody">
        <!-- Contenuto dinamico -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal confronto versioni -->
<div class="modal fade" id="comparisonModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confronto Versioni</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6">
            <h6>Versione 1</h6>
            <select class="form-select" id="version1Select">
              {% for versione in versioni %}
                <option value="{{ versione.id }}">v{{ versione.version_number }} - {{ versione.filename }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-6">
            <h6>Versione 2</h6>
            <select class="form-select" id="version2Select">
              {% for versione in versioni %}
                <option value="{{ versione.id }}">v{{ versione.version_number }} - {{ versione.filename }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="mt-3">
          <button class="btn btn-primary" onclick="confrontaVersioni()">
            <i class="fas fa-balance-scale"></i> Confronta
          </button>
        </div>
        <div id="comparisonResult" class="mt-3">
          <!-- Risultati confronto -->
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<style>
.timeline {
  position: relative;
  padding-left: 30px;
}

.timeline::before {
  content: '';
  position: absolute;
  left: 15px;
  top: 0;
  bottom: 0;
  width: 2px;
  background: #dee2e6;
}

.timeline-item {
  position: relative;
  margin-bottom: 20px;
}

.timeline-marker {
  position: absolute;
  left: -22px;
  top: 0;
  width: 30px;
  height: 30px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
}

.timeline-content {
  background: #f8f9fa;
  padding: 15px;
  border-radius: 5px;
  margin-left: 20px;
}

.timeline-item.active .timeline-content {
  background: #d4edda;
  border: 1px solid #c3e6cb;
}
</style>

<script>
function ripristinaVersione(versionId) {
  if (confirm('Sei sicuro di voler ripristinare questa versione? La versione attuale verr√† salvata come backup.')) {
    fetch(`/docs/versione/${versionId}/ripristina`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('‚úÖ Versione ripristinata con successo!');
        location.reload();
      } else {
        alert('‚ùå Errore: ' + data.message);
      }
    })
    .catch(error => {
      alert('‚ùå Errore durante il ripristino');
    });
  }
}

function eliminaVersione(versionId) {
  if (confirm('Sei sicuro di voler eliminare questa versione? Questa azione non pu√≤ essere annullata.')) {
    fetch(`/docs/versione/${versionId}/elimina`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('‚úÖ Versione eliminata con successo!');
        location.reload();
      } else {
        alert('‚ùå Errore: ' + data.message);
      }
    })
    .catch(error => {
      alert('‚ùå Errore durante l\'eliminazione');
    });
  }
}

function showVersionDetails(versionId) {
  // Implementazione per mostrare dettagli versione
  document.getElementById('versionModalBody').innerHTML = `
    <p>Caricamento dettagli versione ID: ${versionId}...</p>
  `;
  new bootstrap.Modal(document.getElementById('versionModal')).show();
}

function showVersionComparison() {
  new bootstrap.Modal(document.getElementById('comparisonModal')).show();
}

function confrontaVersioni() {
  const version1Id = document.getElementById('version1Select').value;
  const version2Id = document.getElementById('version2Select').value;
  
  if (version1Id === version2Id) {
    alert('Seleziona due versioni diverse per il confronto');
    return;
  }
  
  fetch(`/docs/confronta-versioni/${version1Id}/${version2Id}`)
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        document.getElementById('comparisonResult').innerHTML = `
          <div class="alert alert-info">
            <h6>Risultati Confronto:</h6>
            <p><strong>Dimensione:</strong> ${data.size_diff} MB</p>
            <p><strong>Giorni di differenza:</strong> ${data.date_diff}</p>
            <p><strong>Stesso file:</strong> ${data.same_file ? 'S√¨' : 'No'}</p>
          </div>
        `;
      } else {
        alert('‚ùå Errore nel confronto: ' + data.message);
      }
    })
    .catch(error => {
      alert('‚ùå Errore durante il confronto');
    });
}

function exportVersioni() {
  window.open(`/docs/export-versioni/{{ document.id }}`, '_blank');
}
</script>

</body>
</html> 
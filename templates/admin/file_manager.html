{% extends "base.html" %}

{% block title %}File Manager{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/tabulator@5.5.0/dist/css/tabulator.min.css" rel="stylesheet">
<style>
    .file-manager {
        display: flex;
        height: calc(100vh - 200px);
        gap: 20px;
    }
    
    .sidebar {
        width: 300px;
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        overflow-y: auto;
    }
    
    .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
    }
    
    .toolbar {
        background: white;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .file-table {
        flex: 1;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .tree-item {
        padding: 8px 12px;
        margin: 2px 0;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .tree-item:hover {
        background-color: #e9ecef;
    }
    
    .tree-item.active {
        background-color: #007bff;
        color: white;
    }
    
    .tree-item .count {
        float: right;
        background: #6c757d;
        color: white;
        padding: 2px 6px;
        border-radius: 10px;
        font-size: 12px;
    }
    
    .tree-item.active .count {
        background: rgba(255,255,255,0.3);
    }
    
    .preview-panel {
        position: fixed;
        right: 0;
        top: 0;
        width: 400px;
        height: 100vh;
        background: white;
        box-shadow: -2px 0 10px rgba(0,0,0,0.1);
        transform: translateX(100%);
        transition: transform 0.3s ease;
        z-index: 1000;
        overflow-y: auto;
    }
    
    .preview-panel.open {
        transform: translateX(0);
    }
    
    .preview-content {
        padding: 20px;
    }
    
    .preview-image {
        max-width: 100%;
        height: auto;
        border-radius: 4px;
    }
    
    .batch-actions {
        display: none;
        background: #e3f2fd;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 10px;
    }
    
    .batch-actions.show {
        display: block;
    }
    
    .tag-badge {
        display: inline-block;
        padding: 2px 6px;
        margin: 1px;
        border-radius: 12px;
        font-size: 11px;
        color: white;
    }
    
    .loading {
        display: none;
        text-align: center;
        padding: 20px;
    }
    
    .loading.show {
        display: block;
    }
    
    .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #007bff;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-folder-open"></i> File Manager</h2>
                <div>
                    <button class="btn btn-outline-secondary" onclick="refreshData()">
                        <i class="fas fa-sync-alt"></i> Aggiorna
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="file-manager">
        <!-- Sidebar con Tree -->
        <div class="sidebar">
            <h5><i class="fas fa-sitemap"></i> Struttura</h5>
            <div id="file-tree">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Caricamento struttura...</p>
                </div>
            </div>
        </div>
        
        <!-- Contenuto principale -->
        <div class="main-content">
            <!-- Toolbar con filtri -->
            <div class="toolbar">
                <div class="row">
                    <div class="col-md-3">
                        <label for="company-filter" class="form-label">Azienda:</label>
                        <select id="company-filter" class="form-select">
                            <option value="">Tutte le aziende</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="department-filter" class="form-label">Reparto:</label>
                        <select id="department-filter" class="form-select">
                            <option value="">Tutti i reparti</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="type-filter" class="form-label">Tipo:</label>
                        <select id="type-filter" class="form-select">
                            <option value="">Tutti i tipi</option>
                            <option value="pdf">PDF</option>
                            <option value="doc">Word</option>
                            <option value="xls">Excel</option>
                            <option value="img">Immagini</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="status-filter" class="form-label">Status:</label>
                        <select id="status-filter" class="form-select">
                            <option value="">Tutti</option>
                            <option value="attivo">Attivo</option>
                            <option value="scaduto">Scaduto</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="search-input" class="form-label">Ricerca:</label>
                        <input type="text" id="search-input" class="form-control" placeholder="Cerca...">
                    </div>
                </div>
                
                <!-- Azioni batch -->
                <div id="batch-actions" class="batch-actions">
                    <div class="d-flex justify-content-between align-items-center">
                        <span id="selected-count">0 file selezionati</span>
                        <div>
                            <button class="btn btn-sm btn-outline-primary" onclick="addTags()">
                                <i class="fas fa-tags"></i> Aggiungi Tag
                            </button>
                            <button class="btn btn-sm btn-outline-warning" onclick="moveFiles()">
                                <i class="fas fa-folder-open"></i> Sposta
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteFiles()">
                                <i class="fas fa-trash"></i> Elimina
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="clearSelection()">
                                <i class="fas fa-times"></i> Annulla
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tabella file -->
            <div class="file-table">
                <div id="file-table"></div>
            </div>
        </div>
    </div>
</div>

<!-- Pannello Preview -->
<div id="preview-panel" class="preview-panel">
    <div class="preview-content">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5><i class="fas fa-eye"></i> Anteprima</h5>
            <button class="btn btn-sm btn-outline-secondary" onclick="closePreview()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="preview-content">
            <div class="text-center text-muted">
                <i class="fas fa-file-alt fa-3x mb-3"></i>
                <p>Seleziona un file per visualizzare l'anteprima</p>
            </div>
        </div>
    </div>
</div>

<!-- Modal per aggiunta tag -->
<div class="modal fade" id="addTagsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Aggiungi Tag</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="new-tags" class="form-label">Tag (separati da virgola):</label>
                    <input type="text" id="new-tags" class="form-control" placeholder="es. confidenziale, urgente, haccp">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                <button type="button" class="btn btn-primary" onclick="confirmAddTags()">Aggiungi</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal per spostamento file -->
<div class="modal fade" id="moveFilesModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Sposta File</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="target-folder" class="form-label">Cartella destinazione:</label>
                    <select id="target-folder" class="form-select">
                        <option value="">Seleziona cartella...</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                <button type="button" class="btn btn-primary" onclick="confirmMoveFiles()">Sposta</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/tabulator@5.5.0/dist/js/tabulator.min.js"></script>
<script>
let fileTable;
let selectedFiles = [];
let currentFilters = {};

// Inizializzazione
document.addEventListener('DOMContentLoaded', function() {
    initializeFileTable();
    loadFileTree();
    setupEventListeners();
});

function initializeFileTree() {
    // Carica struttura tree
    fetch('/api/files/tree')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderFileTree(data.data);
            }
        })
        .catch(error => {
            console.error('Errore caricamento tree:', error);
            document.getElementById('file-tree').innerHTML = '<p class="text-danger">Errore caricamento struttura</p>';
        });
}

function renderFileTree(treeData) {
    const treeContainer = document.getElementById('file-tree');
    treeContainer.innerHTML = '';
    
    treeData.companies.forEach(company => {
        const companyItem = document.createElement('div');
        companyItem.className = 'tree-item';
        companyItem.innerHTML = `
            <i class="fas fa-building"></i> ${company.name}
            <span class="count">${company.file_count}</span>
        `;
        companyItem.onclick = () => selectCompany(company.id);
        treeContainer.appendChild(companyItem);
        
        company.departments.forEach(department => {
            const deptItem = document.createElement('div');
            deptItem.className = 'tree-item';
            deptItem.style.marginLeft = '20px';
            deptItem.innerHTML = `
                <i class="fas fa-sitemap"></i> ${department.name}
                <span class="count">${department.file_count}</span>
            `;
            deptItem.onclick = () => selectDepartment(company.id, department.id);
            treeContainer.appendChild(deptItem);
        });
    });
}

function initializeFileTable() {
    fileTable = new Tabulator("#file-table", {
        height: "100%",
        layout: "fitColumns",
        pagination: true,
        paginationSize: 25,
        paginationSizeSelector: [10, 25, 50, 100],
        ajaxURL: "/api/files/list",
        ajaxParams: function() {
            return currentFilters;
        },
        ajaxResponse: function(url, params, response) {
            return response.data;
        },
        columns: [
            {
                formatter: "rowSelection",
                titleFormatter: "rowSelection",
                headerSort: false,
                width: 50,
                cellClick: function(e, cell) {
                    const row = cell.getRow();
                    const fileId = row.getData().id;
                    
                    if (cell.getElement().classList.contains('tabulator-selected')) {
                        selectedFiles = selectedFiles.filter(id => id !== fileId);
                    } else {
                        selectedFiles.push(fileId);
                    }
                    
                    updateBatchActions();
                }
            },
            {
                title: "Nome",
                field: "name",
                headerFilter: true,
                formatter: function(cell) {
                    const data = cell.getData();
                    const icon = getFileIcon(data.file_ext);
                    return `<i class="${icon}"></i> ${data.name}`;
                }
            },
            {
                title: "Dimensione",
                field: "size",
                headerSort: true,
                formatter: function(cell) {
                    const size = cell.getValue();
                    return formatFileSize(size);
                }
            },
            {
                title: "Proprietario",
                field: "owner.username",
                headerFilter: true
            },
            {
                title: "Azienda",
                field: "company.name",
                headerFilter: true
            },
            {
                title: "Reparto",
                field: "department.name",
                headerFilter: true
            },
            {
                title: "Tag",
                field: "tags",
                formatter: function(cell) {
                    const tags = cell.getValue();
                    if (!tags || tags.length === 0) return '-';
                    
                    return tags.map(tag => 
                        `<span class="tag-badge bg-${tag.color}">${tag.name}</span>`
                    ).join(' ');
                }
            },
            {
                title: "Classificazione",
                field: "classification",
                headerFilter: true,
                formatter: function(cell) {
                    const classification = cell.getValue();
                    const badgeClass = getClassificationBadgeClass(classification);
                    return `<span class="badge ${badgeClass}">${classification}</span>`;
                }
            },
            {
                title: "Creato",
                field: "created_at",
                headerSort: true,
                formatter: function(cell) {
                    return new Date(cell.getValue()).toLocaleDateString('it-IT');
                }
            },
            {
                title: "Azioni",
                headerSort: false,
                width: 120,
                formatter: function(cell) {
                    const data = cell.getData();
                    return `
                        <button class="btn btn-sm btn-outline-primary" onclick="previewFile(${data.id})" title="Anteprima">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="editFile(${data.id})" title="Modifica">
                            <i class="fas fa-edit"></i>
                        </button>
                    `;
                }
            }
        ]
    });
}

function setupEventListeners() {
    // Filtri
    document.getElementById('company-filter').addEventListener('change', applyFilters);
    document.getElementById('department-filter').addEventListener('change', applyFilters);
    document.getElementById('type-filter').addEventListener('change', applyFilters);
    document.getElementById('status-filter').addEventListener('change', applyFilters);
    
    // Ricerca
    let searchTimeout;
    document.getElementById('search-input').addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(applyFilters, 300);
    });
}

function applyFilters() {
    currentFilters = {
        company_id: document.getElementById('company-filter').value,
        department_id: document.getElementById('department-filter').value,
        type: document.getElementById('type-filter').value,
        status: document.getElementById('status-filter').value,
        q: document.getElementById('search-input').value
    };
    
    fileTable.setData();
}

function selectCompany(companyId) {
    currentFilters.company_id = companyId;
    currentFilters.department_id = '';
    fileTable.setData();
    
    // Aggiorna filtri UI
    document.getElementById('company-filter').value = companyId;
    document.getElementById('department-filter').value = '';
}

function selectDepartment(companyId, departmentId) {
    currentFilters.company_id = companyId;
    currentFilters.department_id = departmentId;
    fileTable.setData();
    
    // Aggiorna filtri UI
    document.getElementById('company-filter').value = companyId;
    document.getElementById('department-filter').value = departmentId;
}

function updateBatchActions() {
    const batchActions = document.getElementById('batch-actions');
    const selectedCount = document.getElementById('selected-count');
    
    if (selectedFiles.length > 0) {
        batchActions.classList.add('show');
        selectedCount.textContent = `${selectedFiles.length} file selezionati`;
    } else {
        batchActions.classList.remove('show');
    }
}

function clearSelection() {
    selectedFiles = [];
    fileTable.deselectRow();
    updateBatchActions();
}

function addTags() {
    if (selectedFiles.length === 0) {
        alert('Seleziona almeno un file');
        return;
    }
    
    document.getElementById('new-tags').value = '';
    new bootstrap.Modal(document.getElementById('addTagsModal')).show();
}

function confirmAddTags() {
    const tags = document.getElementById('new-tags').value.split(',').map(t => t.trim()).filter(t => t);
    
    if (tags.length === 0) {
        alert('Inserisci almeno un tag');
        return;
    }
    
    fetch('/api/files/batch', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            action: 'tag_add',
            file_ids: selectedFiles,
            tags: tags
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Tag aggiunti a ${data.data.processed} file`);
            clearSelection();
            fileTable.setData();
        } else {
            alert('Errore: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Errore:', error);
        alert('Errore durante l\'aggiunta dei tag');
    });
    
    bootstrap.Modal.getInstance(document.getElementById('addTagsModal')).hide();
}

function moveFiles() {
    if (selectedFiles.length === 0) {
        alert('Seleziona almeno un file');
        return;
    }
    
    // TODO: Implementare selezione cartella
    alert('Funzionalità spostamento non ancora implementata');
}

function deleteFiles() {
    if (selectedFiles.length === 0) {
        alert('Seleziona almeno un file');
        return;
    }
    
    if (!confirm(`Sei sicuro di voler eliminare ${selectedFiles.length} file?`)) {
        return;
    }
    
    fetch('/api/files/batch', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            action: 'delete',
            file_ids: selectedFiles
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`${data.data.processed} file eliminati`);
            clearSelection();
            fileTable.setData();
        } else {
            alert('Errore: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Errore:', error);
        alert('Errore durante l\'eliminazione');
    });
}

function previewFile(fileId) {
    const previewPanel = document.getElementById('preview-panel');
    const previewContent = document.getElementById('preview-content');
    
    previewContent.innerHTML = `
        <div class="text-center">
            <div class="spinner"></div>
            <p>Caricamento anteprima...</p>
        </div>
    `;
    
    previewPanel.classList.add('open');
    
    fetch(`/api/files/${fileId}/preview`)
        .then(response => {
            if (response.ok) {
                return response.blob();
            } else {
                throw new Error('Preview non disponibile');
            }
        })
        .then(blob => {
            const url = URL.createObjectURL(blob);
            previewContent.innerHTML = `
                <img src="${url}" class="preview-image" alt="Anteprima">
            `;
        })
        .catch(error => {
            previewContent.innerHTML = `
                <div class="text-center text-muted">
                    <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                    <p>Anteprima non disponibile</p>
                    <small>${error.message}</small>
                </div>
            `;
        });
}

function closePreview() {
    document.getElementById('preview-panel').classList.remove('open');
}

function editFile(fileId) {
    // TODO: Implementare modifica file
    alert('Funzionalità modifica non ancora implementata');
}

function refreshData() {
    loadFileTree();
    fileTable.setData();
}

// Utility functions
function getFileIcon(extension) {
    const icons = {
        '.pdf': 'fas fa-file-pdf',
        '.doc': 'fas fa-file-word',
        '.docx': 'fas fa-file-word',
        '.xls': 'fas fa-file-excel',
        '.xlsx': 'fas fa-file-excel',
        '.ppt': 'fas fa-file-powerpoint',
        '.pptx': 'fas fa-file-powerpoint',
        '.jpg': 'fas fa-file-image',
        '.jpeg': 'fas fa-file-image',
        '.png': 'fas fa-file-image',
        '.gif': 'fas fa-file-image'
    };
    
    return icons[extension] || 'fas fa-file';
}

function formatFileSize(bytes) {
    if (!bytes) return '-';
    
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(1024));
    return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
}

function getClassificationBadgeClass(classification) {
    const classes = {
        'public': 'bg-success',
        'internal': 'bg-warning',
        'confidential': 'bg-danger'
    };
    
    return classes[classification] || 'bg-secondary';
}
</script>
{% endblock %}

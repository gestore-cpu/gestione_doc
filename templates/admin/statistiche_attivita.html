<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Statistiche Attivit√†</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: #f9f9f9;
        }
        @media (min-width: 768px) {
            body {
                background: #f9f9f9 url('/static/img/sfondo.png') no-repeat center center fixed !important;
                background-size: cover !important;
            }
        }
        .card-metric { text-align: center; padding: 15px; border-radius: 1rem; }
        canvas { max-height: 300px; }
    </style>
</head>
<body class="p-4">
    <div class="container bg-white rounded shadow p-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <img src="{{ url_for('static', filename='logonew.png') }}" alt="Logo Mercury" height="60">
            <h2 class="flex-grow-1 text-center">Statistiche Attivit√†</h2>
            <div class="d-flex align-items-center">
                <form method="get" action="{{ url_for('admin.admin_stats') }}" class="me-2">
                    <select name="days" onchange="this.form.submit()" class="form-select">
                        <option value="7" {% if selected_days == 7 %}selected{% endif %}>Ultimi 7 giorni</option>
                        <option value="30" {% if selected_days == 30 %}selected{% endif %}>Ultimi 30 giorni</option>
                    </select>
                </form>
                <a href="{{ url_for('admin.admin_dashboard') }}" class="btn btn-outline-primary ms-2">üè† Torna alla Dashboard</a>
            </div>
        </div>

        <!-- Registro Attivit√† Utente -->
        <div class="card mb-4">
            <div class="card-header bg-dark text-white">üìã Registro Attivit√† Utente</div>
            <div class="table-responsive">
                <table class="table table-striped table-bordered align-middle mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>Username</th>
                            <th>Nome</th>
                            <th>Cognome</th>
                            <th>Data/Ora</th>
                            <th>Tipo Attivit√†</th>
                            <th>File</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in log_attivita %}
                        <tr>
                            <td>{{ log.username }}</td>
                            <td>{{ log.first_name or '' }}</td>
                            <td>{{ log.last_name or '' }}</td>
                            <td>{{ log.created_at.strftime('%d/%m/%Y %H:%M') }}</td>
                            <td>{{ log.action }}</td>
                            <td>{{ log.filename }}</td>
                        </tr>
                        {% else %}
                        <tr><td colspan="6" class="text-center text-muted">Nessuna attivit√† registrata.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Box metriche -->
        <div class="row text-center mb-4">
            <div class="col-md-3"><div class="bg-primary text-white card-metric">Upload totali<br><strong>{{ total_uploads }}</strong></div></div>
            <div class="col-md-3"><div class="bg-success text-white card-metric">Download totali<br><strong>{{ total_downloads }}</strong></div></div>
            <div class="col-md-3"><div class="bg-warning text-dark card-metric">Guest attivi<br><strong>{{ active_guests }}</strong></div></div>
            <div class="col-md-3"><div class="bg-info text-white card-metric">Utenti totali<br><strong>{{ total_users }}</strong></div></div>
        </div>

        <!-- Pulsante esporta -->
        <div class="text-end mb-3">
            <button class="btn btn-outline-dark" onclick="exportAllCSVs()">‚¨áÔ∏è Esporta Tutto (CSV)</button>
            <button class="btn btn-outline-danger ms-2" onclick="printStatsPDF()">üñ®Ô∏è Esporta Tutto (PDF)</button>
        </div>

        <!-- Grafici -->
        <div class="row">
            <div class="col-md-6 mb-4"><canvas id="weeklyChart"></canvas></div>
            <div class="col-md-6 mb-4"><canvas id="dayChart"></canvas></div>
            <div class="col-md-6 mb-4"><canvas id="companyChart"></canvas></div>
            <div class="col-md-6 mb-4"><canvas id="departmentChart"></canvas></div>
            <div class="col-md-6 mb-4"><canvas id="userChart"></canvas></div>
            <div class="col-md-6 mb-4"><canvas id="typeChart"></canvas></div>
        </div>

        <hr class="my-4">
        <div class="row">
            <div class="col-md-6">
                <h5>Legenda Grafici:</h5>
                <ul>
                    <li><strong>Upload/Download Settimanali</strong>: attivit√† per giorno della settimana</li>
                    <li><strong>Caricamenti Giornalieri</strong>: numero file caricati per data</li>
                    <li><strong>Per Azienda / Reparto / Utente</strong>: upload aggregati</li>
                    <li><strong>Tipologia Documento</strong>: estensioni file (PDF, XLS, ecc.)</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h5>Riepilogo Dati:</h5>
                <table class="table table-sm table-bordered">
                    <tbody>
                        <tr><th>Upload totali</th><td>{{ total_uploads }}</td></tr>
                        <tr><th>Download totali</th><td>{{ total_downloads }}</td></tr>
                        <tr><th>Guest attivi</th><td>{{ active_guests }}</td></tr>
                        <tr><th>Utenti totali</th><td>{{ total_users }}</td></tr>
                        <tr><th>Intervallo selezionato</th><td>{{ selected_days }} giorni</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        const chartOptions = {
            responsive: true,
            plugins: { legend: { position: 'top' }},
            scales: {
                y: { beginAtZero: true, min: 0 },
                x: { ticks: { autoSkip: false, maxRotation: 60, minRotation: 45 } }
            }
        };

        new Chart(document.getElementById('weeklyChart'), {
            type: 'bar',
            data: {
                labels: {{ weekly_labels | tojson }},
                datasets: [
                    { label: 'Upload', data: {{ weekly_uploads | tojson }}, backgroundColor: '#0d6efd' },
                    { label: 'Download', data: {{ weekly_downloads | tojson }}, backgroundColor: '#20c997' }
                ]
            },
            options: chartOptions
        });

        new Chart(document.getElementById('dayChart'), {
            type: 'bar',
            data: {
                labels: {{ uploads_per_day_labels | tojson }},
                datasets: [{ label: 'Upload per giorno', data: {{ uploads_per_day_counts | tojson }}, backgroundColor: '#6f42c1' }]
            },
            options: chartOptions
        });

        new Chart(document.getElementById('companyChart'), {
            type: 'bar',
            data: {
                labels: {{ uploads_by_company_labels | tojson }},
                datasets: [{ label: 'Upload per azienda', data: {{ uploads_by_company_counts | tojson }}, backgroundColor: '#fd7e14' }]
            },
            options: chartOptions
        });

        new Chart(document.getElementById('departmentChart'), {
            type: 'bar',
            data: {
                labels: {{ uploads_by_department_labels | tojson }},
                datasets: [{ label: 'Upload per reparto', data: {{ uploads_by_department_counts | tojson }}, backgroundColor: '#ffc107' }]
            },
            options: chartOptions
        });

        new Chart(document.getElementById('userChart'), {
            type: 'bar',
            data: {
                labels: {{ uploads_by_user_labels | tojson }},
                datasets: [{ label: 'Upload per utente', data: {{ uploads_by_user_counts | tojson }}, backgroundColor: '#198754' }]
            },
            options: chartOptions
        });

        new Chart(document.getElementById('typeChart'), {
            type: 'bar',
            data: {
                labels: {{ doc_type_labels | tojson }},
                datasets: [{ label: 'Tipo documento', data: {{ doc_type_counts | tojson }}, backgroundColor: '#dc3545' }]
            },
            options: chartOptions
        });

        function exportCSV(title, labels, counts) {
            let csv = "Etichetta,Valore\n";
            for (let i = 0; i < labels.length; i++) {
                csv += `"${labels[i]}",${counts[i]}\n`;
            }
            const blob = new Blob([csv], { type: "text/csv" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = title + ".csv";
            link.click();
        }

        function exportAllCSVs() {
            exportCSV("upload_per_giorno", {{ uploads_per_day_labels | tojson }}, {{ uploads_per_day_counts | tojson }});
            exportCSV("upload_per_azienda", {{ uploads_by_company_labels | tojson }}, {{ uploads_by_company_counts | tojson }});
            exportCSV("upload_per_reparto", {{ uploads_by_department_labels | tojson }}, {{ uploads_by_department_counts | tojson }});
            exportCSV("upload_per_utente", {{ uploads_by_user_labels | tojson }}, {{ uploads_by_user_counts | tojson }});
            exportCSV("tipo_documento", {{ doc_type_labels | tojson }}, {{ doc_type_counts | tojson }});
            exportCSV("upload_download_settimanali", {{ weekly_labels | tojson }}, {{ weekly_uploads | tojson }});
        }

        function printStatsPDF() {
            window.print();
        }
    </script>
</body>
</html>

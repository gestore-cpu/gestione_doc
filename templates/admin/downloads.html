{% extends "base.html" %}

{% block title %}Log Download{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
    .filter-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }
    .status-badge {
        font-size: 0.8em;
        padding: 0.25em 0.5em;
    }
    .user-agent-tooltip {
        max-width: 300px;
        word-wrap: break-word;
    }
    .table-responsive {
        max-height: 600px;
        overflow-y: auto;
    }
    .pagination-info {
        font-size: 0.9em;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    üì• Log Download
                </h1>
                <div>
                    <a href="{{ url_for('admin.export_downloads_csv', **filters) }}" class="btn btn-outline-success">
                        üì§ Esporta CSV (Filtri)
                    </a>
                    <a href="{{ url_for('admin.export_all_downloads_csv') }}" class="btn btn-outline-primary">
                        üì§ Esporta Tutto
                    </a>
                </div>
            </div>

            <!-- Statistiche -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="stats-card">
                        <h4>{{ stats.total_count }}</h4>
                        <p class="mb-0">Totale Record</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                        <h4>{{ stats.status_breakdown.get('success', 0) }}</h4>
                        <p class="mb-0">Successi</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card" style="background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);">
                        <h4>{{ stats.status_breakdown.get('blocked', 0) }}</h4>
                        <p class="mb-0">Bloccati</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card" style="background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);">
                        <h4>{{ logs|length }}</h4>
                        <p class="mb-0">In Pagina</p>
                    </div>
                </div>
            </div>

            <!-- Filtri -->
            <div class="filter-section">
                <h5 class="mb-3">üîç Filtri</h5>
                <form method="GET" class="row g-3">
                    <div class="col-md-2">
                        <label for="from" class="form-label">Data da</label>
                        <input type="date" name="from" id="from" class="form-control" value="{{ filters.from }}">
                    </div>
                    <div class="col-md-2">
                        <label for="to" class="form-label">Data a</label>
                        <input type="date" name="to" id="to" class="form-control" value="{{ filters.to }}">
                    </div>
                    <div class="col-md-2">
                        <label for="user_id" class="form-label">Utente ID</label>
                        <input type="number" name="user_id" id="user_id" class="form-control" value="{{ filters.user_id }}">
                    </div>
                    <div class="col-md-2">
                        <label for="username" class="form-label">Username</label>
                        <input type="text" name="username" id="username" class="form-control" value="{{ filters.username }}" placeholder="Ricerca parziale">
                    </div>
                    <div class="col-md-2">
                        <label for="filename" class="form-label">Nome File</label>
                        <input type="text" name="filename" id="filename" class="form-control" value="{{ filters.filename }}" placeholder="Ricerca parziale">
                    </div>
                    <div class="col-md-2">
                        <label for="ip" class="form-label">IP</label>
                        <input type="text" name="ip" id="ip" class="form-control" value="{{ filters.ip }}" placeholder="Ricerca parziale">
                    </div>
                    <div class="col-md-2">
                        <label for="status" class="form-label">Stato</label>
                        <select name="status" id="status" class="form-select">
                            <option value="">Tutti</option>
                            <option value="success" {% if filters.status == 'success' %}selected{% endif %}>Successo</option>
                            <option value="blocked" {% if filters.status == 'blocked' %}selected{% endif %}>Bloccato</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="source" class="form-label">Fonte</label>
                        <select name="source" id="source" class="form-select">
                            <option value="">Tutte</option>
                            <option value="web" {% if filters.source == 'web' %}selected{% endif %}>Web</option>
                            <option value="api" {% if filters.source == 'api' %}selected{% endif %}>API</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">&nbsp;</label>
                        <div>
                            <button type="submit" class="btn btn-primary">üîç Applica Filtri</button>
                            <a href="{{ url_for('admin.downloads_dashboard') }}" class="btn btn-outline-secondary">üîÑ Reset</a>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Tabella Log -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üìä Log Download ({{ pagination.total }} totali)</h5>
                </div>
                <div class="card-body">
                    {% if logs %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>Timestamp</th>
                                    <th>Utente</th>
                                    <th>File</th>
                                    <th>Dimensione</th>
                                    <th>IP</th>
                                    <th>User Agent</th>
                                    <th>Stato</th>
                                    <th>Motivo Blocco</th>
                                    <th>Fonte</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for log in logs %}
                                <tr>
                                    <td>
                                        <strong>#{{ log.id }}</strong>
                                    </td>
                                    <td>
                                        <div>
                                            <strong>{{ log.timestamp.strftime('%d/%m/%Y') }}</strong>
                                            <br>
                                            <small class="text-muted">{{ log.timestamp.strftime('%H:%M:%S') }}</small>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-sm bg-primary rounded-circle d-flex align-items-center justify-content-center me-2">
                                                <span class="text-white">{{ log.username[0].upper() if log.username and log.username != 'N/A' else '?' }}</span>
                                            </div>
                                            <div>
                                                <strong>{{ log.username }}</strong>
                                                <br>
                                                <small class="text-muted">ID: {{ log.user_id }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div>
                                            <strong>{{ log.filename }}</strong>
                                            <br>
                                            <small class="text-muted">ID: {{ log.document_id }}</small>
                                        </div>
                                    </td>
                                    <td>
                                        <code>{{ log.filesize_formatted }}</code>
                                    </td>
                                    <td>
                                        <code>{{ log.ip_address or 'N/A' }}</code>
                                    </td>
                                    <td>
                                        {% if log.user_agent %}
                                        <span class="text-truncate d-inline-block" style="max-width: 200px;" 
                                              data-bs-toggle="tooltip" 
                                              data-bs-placement="top" 
                                              title="{{ log.user_agent }}">
                                            {{ log.user_agent[:50] }}{% if log.user_agent|length > 50 %}...{% endif %}
                                        </span>
                                        {% else %}
                                        <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if log.status == 'success' %}
                                            <span class="badge bg-success status-badge">Successo</span>
                                        {% elif log.status == 'blocked' %}
                                            <span class="badge bg-danger status-badge">Bloccato</span>
                                        {% else %}
                                            <span class="badge bg-secondary status-badge">{{ log.status }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if log.reason_block %}
                                        <span class="text-danger">{{ log.reason_block }}</span>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if log.source == 'web' %}
                                            <span class="badge bg-info status-badge">Web</span>
                                        {% elif log.source == 'api' %}
                                            <span class="badge bg-warning status-badge">API</span>
                                        {% else %}
                                            <span class="badge bg-secondary status-badge">{{ log.source }}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Paginazione -->
                    {% if pagination.pages > 1 %}
                    <nav aria-label="Paginazione log download">
                        <ul class="pagination justify-content-center">
                            {% if pagination.has_prev %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('admin.downloads_dashboard', page=pagination.prev_num, **filters) }}">Precedente</a>
                            </li>
                            {% endif %}
                            
                            {% for page_num in pagination.iter_pages() %}
                                {% if page_num %}
                                    {% if page_num != pagination.page %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('admin.downloads_dashboard', page=page_num, **filters) }}">{{ page_num }}</a>
                                    </li>
                                    {% else %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ page_num }}</span>
                                    </li>
                                    {% endif %}
                                {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">...</span>
                                </li>
                                {% endif %}
                            {% endfor %}
                            
                            {% if pagination.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('admin.downloads_dashboard', page=pagination.next_num, **filters) }}">Successivo</a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    
                    <div class="text-center pagination-info">
                        Mostrando {{ pagination.items|length }} di {{ pagination.total }} record
                        (Pagina {{ pagination.page }} di {{ pagination.pages }})
                    </div>
                    {% endif %}
                    
                    {% else %}
                    <div class="text-center py-5">
                        <div class="mb-3">
                            <i class="fas fa-search fa-3x text-muted"></i>
                        </div>
                        <h5 class="text-muted">Nessun log trovato</h5>
                        <p class="text-muted">Non ci sono log di download con i filtri applicati.</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Info Filtri Applicati -->
            {% if validated_filters %}
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">üìã Filtri Applicati</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                {% if validated_filters.from %}
                                <div class="col-md-3">
                                    <strong>Data da:</strong> {{ validated_filters.from.strftime('%d/%m/%Y') }}
                                </div>
                                {% endif %}
                                {% if validated_filters.to %}
                                <div class="col-md-3">
                                    <strong>Data a:</strong> {{ validated_filters.to.strftime('%d/%m/%Y') }}
                                </div>
                                {% endif %}
                                {% if validated_filters.user_id %}
                                <div class="col-md-3">
                                    <strong>User ID:</strong> {{ validated_filters.user_id }}
                                </div>
                                {% endif %}
                                {% if validated_filters.username %}
                                <div class="col-md-3">
                                    <strong>Username:</strong> {{ validated_filters.username }}
                                </div>
                                {% endif %}
                                {% if validated_filters.filename %}
                                <div class="col-md-3">
                                    <strong>Filename:</strong> {{ validated_filters.filename }}
                                </div>
                                {% endif %}
                                {% if validated_filters.ip %}
                                <div class="col-md-3">
                                    <strong>IP:</strong> {{ validated_filters.ip }}
                                </div>
                                {% endif %}
                                {% if validated_filters.status %}
                                <div class="col-md-3">
                                    <strong>Stato:</strong> {{ validated_filters.status }}
                                </div>
                                {% endif %}
                                {% if validated_filters.source %}
                                <div class="col-md-3">
                                    <strong>Fonte:</strong> {{ validated_filters.source }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Inizializza tooltip
var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl, {
        html: true,
        template: '<div class="tooltip user-agent-tooltip" role="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner"></div></div>'
    })
});

// Auto-refresh ogni 60 secondi
setInterval(function() {
    if (document.visibilityState === 'visible') {
        location.reload();
    }
}, 60000);
</script>
{% endblock %}

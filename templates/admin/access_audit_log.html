{% extends "admin/base_admin.html" %}
{% block content %}
<div class="container-fluid bg-white shadow rounded p-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-history"></i> Log Audit Richieste Accesso</h2>
    <div>
      <a href="{{ url_for('admin.access_requests') }}" class="btn btn-outline-primary">
        <i class="fas fa-list"></i> Lista Richieste
      </a>
      <a href="{{ url_for('admin.access_requests_dashboard') }}" class="btn btn-info">
        <i class="fas fa-chart-line"></i> Dashboard
      </a>
    </div>
  </div>

  <!-- Statistiche -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card bg-primary text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h4 class="card-title">{{ stats.total_requests }}</h4>
              <p class="card-text">Totale Richieste</p>
            </div>
            <div class="align-self-center">
              <i class="fas fa-file-alt fa-2x"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-success text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h4 class="card-title">{{ stats.approved_requests }}</h4>
              <p class="card-text">Approvate</p>
            </div>
            <div class="align-self-center">
              <i class="fas fa-check-circle fa-2x"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-danger text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h4 class="card-title">{{ stats.denied_requests }}</h4>
              <p class="card-text">Negate</p>
            </div>
            <div class="align-self-center">
              <i class="fas fa-times-circle fa-2x"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-info text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h4 class="card-title">{{ "%.1f"|format(stats.approval_rate) }}%</h4>
              <p class="card-text">Tasso Approvazione</p>
            </div>
            <div class="align-self-center">
              <i class="fas fa-percentage fa-2x"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabella Log -->
  <div class="card">
    <div class="card-header">
      <h5 class="mb-0"><i class="fas fa-table"></i> Log Eventi Richieste Accesso</h5>
    </div>
    <div class="card-body">
      {% if logs %}
      <div class="table-responsive">
        <table class="table table-striped table-hover">
          <thead class="table-dark">
            <tr>
              <th>Data/Ora</th>
              <th>Utente</th>
              <th>Documento</th>
              <th>Tipo Evento</th>
              <th>Dettagli</th>
            </tr>
          </thead>
          <tbody>
            {% for log in logs %}
            <tr>
              <td>
                <strong>{{ log.timestamp.strftime('%d/%m/%Y') }}</strong><br>
                <small class="text-muted">{{ log.timestamp.strftime('%H:%M:%S') }}</small>
              </td>
              <td>
                <strong>{{ log.user.username }}</strong><br>
                <small class="text-muted">{{ log.user.email }}</small>
              </td>
              <td>
                <strong>{{ log.document.title or log.document.original_filename }}</strong><br>
                <small class="text-muted">ID: {{ log.document_id }}</small>
              </td>
              <td>
                <span class="badge {% if log.azione == 'request_created' %}bg-secondary{% elif log.azione == 'request_approved' %}bg-success{% elif log.azione == 'request_denied' %}bg-danger{% else %}bg-warning{% endif %}">
                  {{ log.azione_display }}
                </span>
              </td>
              <td>
                {% if log.note %}
                  {% set extra_data = log.note|from_json %}
                  {% if extra_data.reason %}
                    <strong>Motivazione:</strong> {{ extra_data.reason }}<br>
                  {% endif %}
                  {% if extra_data.response_message %}
                    <strong>Risposta Admin:</strong> {{ extra_data.response_message }}<br>
                  {% endif %}
                  {% if extra_data.admin_id %}
                    <small class="text-muted">Admin ID: {{ extra_data.admin_id }}</small>
                  {% endif %}
                {% else %}
                  <span class="text-muted">â€”</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="text-center py-5">
        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
        <h4 class="text-muted">Nessun log disponibile</h4>
        <p class="text-muted">Non ci sono ancora log di richieste di accesso.</p>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Paginazione -->
  {% if logs|length >= 200 %}
  <div class="mt-3 text-center">
    <small class="text-muted">Mostrando gli ultimi 200 log. Per vedere tutti i log, usa la dashboard.</small>
  </div>
  {% endif %}
</div>

<script>
  // Funzione per parsare JSON (se non disponibile in Jinja2)
  function parseJson(jsonString) {
    try {
      return JSON.parse(jsonString);
    } catch (e) {
      return {};
    }
  }
</script>
{% endblock %} 
{% extends "admin/base_admin.html" %}
{% block content %}
<div class="container bg-white shadow rounded p-4">
  <h2>ðŸ“¨ Richieste Accesso Documenti</h2>
  
  <!-- Filtri -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0"><i class="fas fa-filter"></i> Filtri</h5>
    </div>
    <div class="card-body">
      <form method="GET" action="{{ url_for('admin.access_requests') }}" class="row g-3">
        <div class="col-md-3">
          <label for="status" class="form-label">Stato</label>
          <select name="status" id="status" class="form-select">
            <option value="">Tutti gli stati</option>
            <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>In attesa</option>
            <option value="approved" {% if status_filter == 'approved' %}selected{% endif %}>Approvata</option>
            <option value="denied" {% if status_filter == 'denied' %}selected{% endif %}>Rifiutata</option>
          </select>
        </div>
        <div class="col-md-3">
          <label for="username" class="form-label">Utente</label>
          <input type="text" name="username" id="username" class="form-control" 
                 value="{{ username_filter }}" placeholder="Cerca per username">
        </div>
        <div class="col-md-2">
          <label for="date_from" class="form-label">Data da</label>
          <input type="date" name="date_from" id="date_from" class="form-control" 
                 value="{{ date_from }}">
        </div>
        <div class="col-md-2">
          <label for="date_to" class="form-label">Data a</label>
          <input type="date" name="date_to" id="date_to" class="form-control" 
                 value="{{ date_to }}">
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <div class="d-grid gap-2 w-100">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-search"></i> Filtra
            </button>
            <a href="{{ url_for('admin.access_requests') }}" class="btn btn-outline-secondary">
              <i class="fas fa-times"></i> Reset
            </a>
          </div>
        </div>
      </form>
    </div>
  </div>
  
  {% if requests %}
  <table class="table table-bordered table-hover mt-3">
    <thead class="table-light">
      <tr>
        <th>Utente</th>
        <th>Documento</th>
        <th>Nota</th>
        <th>Data Richiesta</th>
        <th>Stato</th>
        <th>Azioni</th>
      </tr>
    </thead>
    <tbody>
      {% for req in requests %}
      <tr>
        <td>
          <strong>{{ req.user.username }}</strong><br>
          <small class="text-muted">{{ req.user.email }}</small>
        </td>
        <td>
          <strong>{{ req.document.title or req.document.original_filename }}</strong><br>
          <small class="text-muted">{{ req.document.company.name if req.document.company else 'N/A' }} - {{ req.document.department.name if req.document.department else 'N/A' }}</small>
        </td>
        <td>
          {% if req.note %}
            {{ req.note }}
          {% else %}
            <span class="text-muted">â€”</span>
          {% endif %}
        </td>
        <td>{{ req.created_at.strftime('%d/%m/%Y %H:%M') }}</td>
        <td>
          {% if req.status == "pending" %}
            <span class="badge bg-secondary">In attesa</span>
          {% elif req.status == "approved" %}
            <span class="badge bg-success">Approvata</span>
          {% elif req.status == "denied" %}
            <span class="badge bg-danger">Rifiutata</span>
          {% else %}
            <span class="badge bg-warning text-dark">{{ req.status.capitalize() }}</span>
          {% endif %}
        </td>
        <td>
          {% if req.status == "pending" %}
          <form method="post" action="{{ url_for('admin.handle_access_request', req_id=req.id) }}" class="d-inline">
            <button name="action" value="approve" class="btn btn-success btn-sm">
              <i class="fas fa-check"></i> Approva
            </button>
            <button name="action" value="deny" class="btn btn-danger btn-sm">
              <i class="fas fa-times"></i> Nega
            </button>
          </form>
          {% else %}
            <small class="text-muted">
              Gestita il {{ req.resolved_at.strftime('%d/%m/%Y') if req.resolved_at else 'N/A' }}
            </small>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <div class="text-center py-5">
    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
    <h4 class="text-muted">Nessuna richiesta di accesso presente</h4>
    <p class="text-muted">Non ci sono richieste di accesso in attesa di approvazione.</p>
  </div>
  {% endif %}
  
  <div class="mt-4 d-flex justify-content-between">
    <a href="{{ url_for('admin.admin_dashboard') }}" class="btn btn-secondary">
      <i class="fas fa-arrow-left"></i> Torna alla Dashboard
    </a>
    <a href="{{ url_for('admin.export_access_requests') }}?{{ request.query_string.decode() }}" class="btn btn-success">
      <i class="fas fa-download"></i> Export CSV
    </a>
  </div>
</div>
{% endblock %} 
{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>ÔøΩÔøΩ AI Risk Scoring Dashboard</h2>
    <p class="text-muted">Gestione del punteggio di rischio AI per le richieste di accesso</p>

    <!-- Statistiche -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title">Punteggio Medio</h5>
                    <h3>{{ stats.average_score }}/100</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title">Rischio Basso</h5>
                    <h3>{{ stats.low_risk_count }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark">
                <div class="card-body">
                    <h5 class="card-title">Rischio Medio</h5>
                    <h3>{{ stats.medium_risk_count }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <h5 class="card-title">Rischio Alto</h5>
                    <h3>{{ stats.high_risk_count }}</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Azioni -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>Azioni</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('risk.bulk_risk_calculation') }}" class="d-inline">
                        <button type="submit" class="btn btn-primary">
                            üîÑ Calcola Risk Score per tutte le richieste pendenti
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtri -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>Filtri</h5>
                </div>
                <div class="card-body">
                    <form method="GET" class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Livello Rischio</label>
                            <select name="risk_level" class="form-select">
                                <option value="">Tutti</option>
                                <option value="high" {% if risk_filter == "high" %}selected{% endif %}>Alto (‚â•70)</option>
                                <option value="medium" {% if risk_filter == "medium" %}selected{% endif %}>Medio (40-69)</option>
                                <option value="low" {% if risk_filter == "low" %}selected{% endif %}>Basso (<40)</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Stato</label>
                            <select name="status" class="form-select">
                                <option value="">Tutti</option>
                                <option value="pending" {% if status_filter == "pending" %}selected{% endif %}>In attesa</option>
                                <option value="approved" {% if status_filter == "approved" %}selected{% endif %}>Approvata</option>
                                <option value="denied" {% if status_filter == "denied" %}selected{% endif %}>Negata</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">&nbsp;</label>
                            <button type="submit" class="btn btn-primary d-block">üîç Filtra</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Richieste ad alto rischio -->
    {% if high_risk_requests %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    <h5>‚ö†Ô∏è Richieste ad Alto Rischio</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Utente</th>
                                    <th>Documento</th>
                                    <th>Risk Score</th>
                                    <th>Stato</th>
                                    <th>Data</th>
                                    <th>Azioni</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for req in high_risk_requests %}
                                <tr>
                                    <td>{{ req.user.first_name }} {{ req.user.last_name }}</td>
                                    <td>{{ req.document.title }}</td>
                                    <td>
                                        <span class="badge bg-danger">{{ req.risk_display }}</span>
                                    </td>
                                    <td>
                                        {% if req.status == 'pending' %}
                                            <span class="badge bg-warning">In attesa</span>
                                        {% elif req.status == 'approved' %}
                                            <span class="badge bg-success">Approvata</span>
                                        {% else %}
                                            <span class="badge bg-danger">Negata</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ req.created_at.strftime('%d/%m/%Y %H:%M') }}</td>
                                    <td>
                                        <a href="{{ url_for('risk.view_risk_analysis', request_id=req.id) }}" 
                                           class="btn btn-sm btn-outline-info">üîç Analisi</a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Lista richieste -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>Richieste di Accesso con Risk Score</h5>
                </div>
                <div class="card-body">
                    {% if requests %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Utente</th>
                                    <th>Documento</th>
                                    <th>Risk Score</th>
                                    <th>Stato</th>
                                    <th>Data</th>
                                    <th>Azioni</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for req in requests %}
                                <tr>
                                    <td>{{ req.user.first_name }} {{ req.user.last_name }}</td>
                                    <td>{{ req.document.title }}</td>
                                    <td>
                                        {% if req.risk_score %}
                                            <span class="badge {{ req.risk_badge_class }}">{{ req.risk_display }}</span>
                                        {% else %}
                                            <span class="badge bg-secondary">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if req.status == 'pending' %}
                                            <span class="badge bg-warning">In attesa</span>
                                        {% elif req.status == 'approved' %}
                                            <span class="badge bg-success">Approvata</span>
                                        {% else %}
                                            <span class="badge bg-danger">Negata</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ req.created_at.strftime('%d/%m/%Y %H:%M') }}</td>
                                    <td>
                                        {% if not req.risk_score %}
                                            <form method="POST" action="{{ url_for('risk.calculate_request_risk', request_id=req.id) }}" class="d-inline">
                                                <button type="submit" class="btn btn-sm btn-outline-primary">üìä Calcola</button>
                                            </form>
                                        {% else %}
                                            <a href="{{ url_for('risk.view_risk_analysis', request_id=req.id) }}" 
                                               class="btn btn-sm btn-outline-info">üîç Analisi</a>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h4 class="text-muted">Nessuna richiesta trovata</h4>
                        <p class="text-muted">Non ci sono richieste che corrispondono ai filtri selezionati.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

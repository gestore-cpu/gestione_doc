<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Suggerimenti AI - Gestione Documenti</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    .suggestion-card {
      border-left: 4px solid #007bff;
      background: #f8f9fa;
    }
    .gpt-result {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      white-space: pre-wrap;
    }
    .loading-spinner {
      display: none;
    }
    .user-row {
      transition: all 0.3s ease;
    }
    .user-row:hover {
      background-color: #f8f9fa;
    }
  </style>
</head>
<body class="bg-light">

<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
          <i class="fas fa-brain text-primary"></i> 
          Suggerimenti AI
        </h2>
        <a href="{{ url_for('admin.admin_dashboard') }}" class="btn btn-outline-secondary">
          <i class="fas fa-arrow-left"></i> Torna alla Dashboard
        </a>
      </div>

      <!-- Statistiche AI -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="card bg-primary text-white">
            <div class="card-body text-center">
              <h5 class="card-title">üß† Suggerimenti</h5>
              <h3>{{ stats.total_suggestions }}</h3>
              <small>Generati oggi</small>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-success text-white">
            <div class="card-body text-center">
              <h5 class="card-title">‚úÖ Risolti</h5>
              <h3>{{ stats.resolved_suggestions }}</h3>
              <small>Completati</small>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-warning text-dark">
            <div class="card-body text-center">
              <h5 class="card-title">‚è≥ In Attesa</h5>
              <h3>{{ stats.pending_suggestions }}</h3>
              <small>Da gestire</small>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-info text-white">
            <div class="card-body text-center">
              <h5 class="card-title">üìä Accuratezza</h5>
              <h3>{{ stats.accuracy }}%</h3>
              <small>AI Precision</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Sezione GPT -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-robot"></i> 
            Generazione Suggerimenti GPT
          </h5>
        </div>
        <div class="card-body">
          <p class="text-muted">
            Analizza i dati degli utenti e genera suggerimenti personalizzati per migliorare la formazione e la compliance.
          </p>
          
          <button id="genera-suggerimenti-gpt" class="btn btn-primary mt-3">
            <i class="fas fa-brain"></i> 
            üß† Genera suggerimenti GPT
            <span class="loading-spinner ms-2">
              <i class="fas fa-spinner fa-spin"></i>
            </span>
          </button>

          <div id="risultato-gpt" class="mt-4 p-3 gpt-result" style="display: none;"></div>
        </div>
      </div>

      <!-- Lista Utenti per Analisi -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-users"></i> 
            Dati Utenti per Analisi AI
          </h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-light">
                <tr>
                  <th>üë§ Utente</th>
                  <th>üìß Email</th>
                  <th>‚úÖ Corsi Completati</th>
                  <th>‚ùå Corsi Mancanti</th>
                  <th>üìä Progresso</th>
                  <th>üè∑Ô∏è Tag AI</th>
                </tr>
              </thead>
              <tbody>
                {% for user in users %}
                <tr class="user-row" 
                    data-nome="{{ user.first_name }}"
                    data-cognome="{{ user.last_name }}"
                    data-email="{{ user.email }}"
                    data-completati="{{ user.corsi_completati|join(',') }}"
                    data-mancanti="{{ user.corsi_mancanti|join(',') }}"
                    data-progresso="{{ user.progresso_percentuale }}">
                  <td>
                    <strong>{{ user.first_name }} {{ user.last_name }}</strong>
                    <br><small class="text-muted">{{ user.role|title }}</small>
                  </td>
                  <td>{{ user.email }}</td>
                  <td>
                    {% if user.corsi_completati %}
                      {% for corso in user.corsi_completati[:3] %}
                        <span class="badge bg-success">{{ corso }}</span>
                      {% endfor %}
                      {% if user.corsi_completati|length > 3 %}
                        <span class="badge bg-secondary">+{{ user.corsi_completati|length - 3 }}</span>
                      {% endif %}
                    {% else %}
                      <span class="text-muted">Nessun corso</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if user.corsi_mancanti %}
                      {% for corso in user.corsi_mancanti[:3] %}
                        <span class="badge bg-warning">{{ corso }}</span>
                      {% endfor %}
                      {% if user.corsi_mancanti|length > 3 %}
                        <span class="badge bg-secondary">+{{ user.corsi_mancanti|length - 3 }}</span>
                      {% endif %}
                    {% else %}
                      <span class="text-success">‚úÖ Tutti completati</span>
                    {% endif %}
                  </td>
                  <td>
                    <div class="progress" style="height: 20px;">
                      <div class="progress-bar bg-success" 
                           style="width: {{ user.progresso_percentuale }}%">
                        {{ user.progresso_percentuale }}%
                      </div>
                    </div>
                  </td>
                  <td>
                    {% if user.tag_ai %}
                      <span class="badge bg-info">{{ user.tag_ai }}</span>
                    {% else %}
                      <span class="text-muted">-</span>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Suggerimenti Esistenti -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-lightbulb"></i> 
            Suggerimenti Generati
          </h5>
        </div>
        <div class="card-body">
          {% if suggerimenti %}
            {% for suggerimento in suggerimenti %}
            <div class="suggestion-card p-3 mb-3">
              <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                  <h6 class="mb-2">
                    <i class="fas fa-lightbulb text-warning"></i> 
                    {{ suggerimento.titolo }}
                  </h6>
                  <p class="mb-2">{{ suggerimento.descrizione }}</p>
                  <small class="text-muted">
                    <i class="fas fa-clock"></i> 
                    Generato il {{ suggerimento.data_creazione.strftime('%d/%m/%Y %H:%M') }}
                  </small>
                </div>
                <div class="ms-3">
                  {% if suggerimento.stato == 'risolto' %}
                    <span class="badge bg-success">‚úÖ Risolto</span>
                  {% elif suggerimento.stato == 'in_corso' %}
                    <span class="badge bg-warning">‚è≥ In Corso</span>
                  {% else %}
                    <span class="badge bg-secondary">üìã Nuovo</span>
                  {% endif %}
                </div>
              </div>
              {% if suggerimento.azioni %}
              <div class="mt-3">
                <strong>Azioni suggerite:</strong>
                <ul class="mb-0 mt-2">
                  {% for azione in suggerimento.azioni %}
                  <li>{{ azione }}</li>
                  {% endfor %}
                </ul>
              </div>
              {% endif %}
            </div>
            {% endfor %}
          {% else %}
            <div class="text-center py-4">
              <i class="fas fa-lightbulb text-muted" style="font-size: 3rem;"></i>
              <p class="text-muted mt-3">Nessun suggerimento generato ancora.</p>
              <p class="text-muted">Clicca su "Genera suggerimenti GPT" per iniziare.</p>
            </div>
          {% endif %}
        </div>
      </div>

    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.getElementById('genera-suggerimenti-gpt').addEventListener('click', async () => {
    const button = document.getElementById('genera-suggerimenti-gpt');
    const risultatoDiv = document.getElementById('risultato-gpt');
    const spinner = button.querySelector('.loading-spinner');
    
    // Mostra spinner e disabilita pulsante
    spinner.style.display = 'inline-block';
    button.disabled = true;
    risultatoDiv.style.display = 'block';
    risultatoDiv.textContent = "‚è≥ Generazione in corso... attendere prego.";

    try {
        // Raccogli dati utenti dalla tabella
        const utenti = [...document.querySelectorAll('.user-row')].map(row => ({
            nome: row.dataset.nome,
            cognome: row.dataset.cognome,
            email: row.dataset.email,
            completati: row.dataset.completati ? row.dataset.completati.split(',').filter(c => c) : [],
            mancanti: row.dataset.mancanti ? row.dataset.mancanti.split(',').filter(c => c) : [],
            progresso: parseInt(row.dataset.progresso) || 0
        }));

        // Invia richiesta al server
        const response = await fetch('/admin/suggerimenti-ai/gpt', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify({ utenti })
        });

        if (!response.ok) {
            throw new Error(`Errore HTTP: ${response.status}`);
        }

        const data = await response.json();
        
        if (data.success) {
            risultatoDiv.innerHTML = `
                <div class="alert alert-success">
                    <h6><i class="fas fa-check-circle"></i> Suggerimenti generati con successo!</h6>
                    <hr>
                    <div style="white-space: pre-wrap; font-family: 'Courier New', monospace;">
${data.suggerimenti}
                    </div>
                </div>
            `;
        } else {
            throw new Error(data.error || 'Errore sconosciuto');
        }

    } catch (error) {
        console.error('Errore:', error);
        risultatoDiv.innerHTML = `
            <div class="alert alert-danger">
                <h6><i class="fas fa-exclamation-triangle"></i> Errore durante la generazione</h6>
                <p class="mb-0">${error.message}</p>
            </div>
        `;
    } finally {
        // Nascondi spinner e riabilita pulsante
        spinner.style.display = 'none';
        button.disabled = false;
    }
});

// Funzione per aggiornare statistiche in tempo reale
function updateStats() {
    fetch('/admin/api/suggerimenti-ai/stats')
        .then(response => response.json())
        .then(data => {
            // Aggiorna le statistiche nella pagina
            document.querySelector('.card.bg-primary h3').textContent = data.total_suggestions;
            document.querySelector('.card.bg-success h3').textContent = data.resolved_suggestions;
            document.querySelector('.card.bg-warning h3').textContent = data.pending_suggestions;
            document.querySelector('.card.bg-info h3').textContent = data.accuracy + '%';
        })
        .catch(error => console.error('Errore aggiornamento stats:', error));
}

// Aggiorna statistiche ogni 30 secondi
setInterval(updateStats, 30000);
</script>

</body>
</html> 
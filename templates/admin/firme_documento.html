<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Firme Documento - {{ documento.title }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-5">
  <div class="row">
    <div class="col-12">
      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
          <i class="fas fa-signature text-primary"></i> 
          Firme Documento
        </h2>
        <a href="{{ url_for('docs.view_document', document_id=documento.id) }}" class="btn btn-secondary">
          <i class="fas fa-arrow-left"></i> Torna al Documento
        </a>
      </div>

      <!-- Informazioni documento -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-file-alt"></i> 
            Informazioni Documento
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <p><strong>Titolo:</strong> {{ documento.title }}</p>
              <p><strong>Categoria:</strong> 
                {% if documento.categoria_ai %}
                  <span class="badge bg-info">{{ documento.categoria_ai }}</span>
                {% else %}
                  <span class="text-muted">-</span>
                {% endif %}
              </p>
              <p><strong>Tag:</strong> 
                {% if documento.tag %}
                  <span class="badge bg-primary">{{ documento.tag }}</span>
                {% else %}
                  <span class="text-muted">-</span>
                {% endif %}
              </p>
            </div>
            <div class="col-md-6">
              <p><strong>Uploader:</strong> {{ documento.uploader_email }}</p>
              <p><strong>Data Caricamento:</strong> {{ documento.created_at.strftime('%d/%m/%Y %H:%M') if documento.created_at else '-' }}</p>
              <p><strong>Totale Firme:</strong> <span class="badge bg-success">{{ firme|length }}</span></p>
            </div>
          </div>
        </div>
      </div>

      <!-- Messaggi flash -->
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Chiudi"></button>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <!-- Statistiche firme -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="card bg-primary text-white">
            <div class="card-body text-center">
              <h5 class="card-title">‚úçÔ∏è Totali</h5>
              <h3>{{ firme|length }}</h3>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-success text-white">
            <div class="card-body text-center">
              <h5 class="card-title">‚úÖ Oggi</h5>
              <h3>{{ firme|selectattr('data_firma', '>=', today)|list|length }}</h3>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-info text-white">
            <div class="card-body text-center">
              <h5 class="card-title">üìÖ Questa Settimana</h5>
              <h3>{{ firme|selectattr('data_firma', '>=', week_ago)|list|length }}</h3>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-warning text-dark">
            <div class="card-body text-center">
              <h5 class="card-title">üìä Ultimo Mese</h5>
              <h3>{{ firme|selectattr('data_firma', '>=', month_ago)|list|length }}</h3>
            </div>
          </div>
        </div>
      </div>

      <!-- Lista firme -->
      {% if firme %}
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
              <i class="fas fa-list"></i> 
              Firme Registrate
            </h5>
            <div>
              <button class="btn btn-sm btn-outline-primary" onclick="exportCSV()">
                <i class="fas fa-download"></i> Esporta CSV
              </button>
              <button class="btn btn-sm btn-outline-success" onclick="printReport()">
                <i class="fas fa-print"></i> Stampa
              </button>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover" id="firme-table">
                <thead class="table-light">
                  <tr>
                    <th>üë§ Utente</th>
                    <th>‚úçÔ∏è Nome Firma</th>
                    <th>üìÖ Data Firma</th>
                    <th>üïê Ora</th>
                    <th>üåê IP Address</th>
                    <th>üì± User Agent</th>
                    <th>üìä Azioni</th>
                  </tr>
                </thead>
                <tbody>
                  {% for firma in firme %}
                    <tr>
                      <td>
                        <strong>{{ firma.user.username }}</strong>
                        <br><small class="text-muted">{{ firma.user.email }}</small>
                      </td>
                      <td>
                        <strong>{{ firma.nome_firma }}</strong>
                      </td>
                      <td>
                        {{ firma.data_firma.strftime('%d/%m/%Y') }}
                      </td>
                      <td>
                        {{ firma.data_firma.strftime('%H:%M') }}
                      </td>
                      <td>
                        <code>{{ firma.ip_address or '-' }}</code>
                      </td>
                      <td>
                        <small class="text-muted">
                          {{ firma.user_agent[:50] + '...' if firma.user_agent and firma.user_agent|length > 50 else firma.user_agent or '-' }}
                        </small>
                      </td>
                      <td>
                        <button class="btn btn-sm btn-outline-info" 
                                onclick="showFirmaDetails({{ firma.id }})"
                                title="Dettagli firma">
                          <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" 
                                onclick="deleteFirma({{ firma.id }})"
                                title="Elimina firma">
                          <i class="fas fa-trash"></i>
                        </button>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      {% else %}
        <div class="alert alert-info">
          <h5><i class="fas fa-info-circle"></i> Nessuna firma registrata</h5>
          <p class="mb-0">Questo documento non ha ancora ricevuto firme.</p>
        </div>
      {% endif %}

      <!-- Grafico firme nel tempo -->
      {% if firme %}
        <div class="card mt-4">
          <div class="card-header">
            <h5 class="mb-0">
              <i class="fas fa-chart-line"></i> 
              Andamento Firme
            </h5>
          </div>
          <div class="card-body">
            <canvas id="firmeChart" width="400" height="200"></canvas>
          </div>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Modal dettagli firma -->
<div class="modal fade" id="firmaModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Dettagli Firma</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="firmaModalBody">
        <!-- Contenuto dinamico -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Dati per il grafico
const firmeData = {
  labels: {{ firme|map(attribute='data_firma.strftime', '%d/%m')|list|tojson }},
  datasets: [{
    label: 'Firme per giorno',
    data: {{ firme|groupby('data_firma.strftime', '%Y-%m-%d')|map('length')|list|tojson }},
    borderColor: 'rgb(75, 192, 192)',
    backgroundColor: 'rgba(75, 192, 192, 0.2)',
    tension: 0.1
  }]
};

// Inizializza grafico
if (document.getElementById('firmeChart')) {
  const ctx = document.getElementById('firmeChart').getContext('2d');
  new Chart(ctx, {
    type: 'line',
    data: firmeData,
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 1
          }
        }
      }
    }
  });
}

// Funzioni utility
function showFirmaDetails(firmaId) {
  // Implementazione per mostrare dettagli firma
  document.getElementById('firmaModalBody').innerHTML = `
    <p>Caricamento dettagli firma ID: ${firmaId}...</p>
  `;
  new bootstrap.Modal(document.getElementById('firmaModal')).show();
}

function deleteFirma(firmaId) {
  if (confirm('Sei sicuro di voler eliminare questa firma? Questa azione non pu√≤ essere annullata.')) {
    // Implementazione eliminazione firma
    console.log('Elimina firma:', firmaId);
  }
}

function exportCSV() {
  const table = document.getElementById('firme-table');
  const rows = table.querySelectorAll('tbody tr');
  let csv = 'Utente,Nome Firma,Data Firma,Ora,IP Address\n';
  
  rows.forEach(row => {
    const cells = row.querySelectorAll('td');
    const user = cells[0].textContent.trim();
    const nome = cells[1].textContent.trim();
    const data = cells[2].textContent.trim();
    const ora = cells[3].textContent.trim();
    const ip = cells[4].textContent.trim();
    
    csv += `"${user}","${nome}","${data}","${ora}","${ip}"\n`;
  });
  
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'firme_documento_{{ documento.id }}.csv';
  a.click();
  window.URL.revokeObjectURL(url);
}

function printReport() {
  window.print();
}
</script>

</body>
</html> 
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Visualizza Documento - {{ document.title }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .document-card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
    }
    .version-table {
      background: white;
      border-radius: 10px;
      overflow: hidden;
    }
    .version-table th {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      border: none;
    }
    .badge {
      font-size: 0.8em;
      padding: 0.5em 0.8em;
    }
    .btn-action {
      border-radius: 20px;
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
    }
    .upload-form {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
    }
  </style>
</head>
<body>

<div class="container-fluid py-4">
  
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="document-card p-4">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h1 class="text-primary mb-2">
              <i class="fas fa-file-alt me-2"></i>
              {{ document.title or document.original_filename }}
            </h1>
            <p class="text-muted mb-0">
              {{ document.description or 'Nessuna descrizione' }}
            </p>
          </div>
          <div>
            <a href="{{ url_for('index') }}" class="btn btn-outline-secondary btn-action">
              <i class="fas fa-arrow-left me-1"></i>
              üîô Torna alla Dashboard
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Informazioni Documento -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="document-card p-4">
        <h5 class="text-primary mb-3">
          <i class="fas fa-info-circle me-2"></i>
          Informazioni Documento
        </h5>
        <div class="row">
          <div class="col-6">
            <p><strong>Caricato da:</strong><br>{{ document.uploader_email }}</p>
            <p><strong>Data creazione:</strong><br>{{ document.created_at.strftime('%d/%m/%Y %H:%M') }}</p>
            <p><strong>Visibilit√†:</strong><br>{{ document.visibility }}</p>
          </div>
          <div class="col-6">
            <p><strong>Azienda:</strong><br>{{ document.company.name }}</p>
            <p><strong>Reparto:</strong><br>{{ document.department.name }}</p>
            <p><strong>Stato:</strong><br>
              {% if document.validazione_admin and document.validazione_ceo %}
                <span class="badge bg-success">‚úÖ Approvato</span>
              {% elif document.validazione_admin %}
                <span class="badge bg-warning">‚è≥ In attesa CEO</span>
              {% elif document.validazione_ceo %}
                <span class="badge bg-warning">‚è≥ In attesa Admin</span>
              {% else %}
                <span class="badge bg-danger">‚ùå Non approvato</span>
              {% endif %}
            </p>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-md-6">
      <div class="document-card p-4">
        <h5 class="text-primary mb-3">
          <i class="fas fa-upload me-2"></i>
          Carica Nuova Versione
        </h5>
        
        <form method="POST" action="{{ url_for('docs.upload_new_version', document_id=document.id) }}" enctype="multipart/form-data">
          <div class="mb-3">
            <label for="file" class="form-label">Seleziona File</label>
            <input type="file" class="form-control" id="file" name="file" required 
                   accept=".pdf,.docx,.xlsx,.txt">
            <div class="form-text">Formati supportati: PDF, DOCX, XLSX, TXT</div>
          </div>
          
          <div class="mb-3">
            <label for="note" class="form-label">Note sulla versione (opzionale)</label>
            <textarea class="form-control" id="note" name="note" rows="3" 
                      placeholder="Descrivi le modifiche apportate..."></textarea>
          </div>
          
          <button type="submit" class="btn btn-primary btn-action">
            <i class="fas fa-upload me-1"></i>
            üì§ Carica Nuova Versione
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Storico Versioni -->
  <div class="row">
    <div class="col-12">
      <div class="document-card p-4">
        <h5 class="text-primary mb-3">
          <i class="fas fa-history me-2"></i>
          üìÑ Storico Versioni
        </h5>
        
        {% if versions %}
          <div class="table-responsive">
            <table class="table table-hover version-table">
              <thead>
                <tr>
                  <th><i class="fas fa-hashtag me-1"></i> Versione</th>
                  <th><i class="fas fa-user me-1"></i> Caricata da</th>
                  <th><i class="fas fa-calendar me-1"></i> Data</th>
                  <th><i class="fas fa-sticky-note me-1"></i> Note</th>
                  <th><i class="fas fa-robot me-1"></i> Confronto AI</th>
                  <th><i class="fas fa-cogs me-1"></i> Azioni</th>
                </tr>
              </thead>
              <tbody>
                {% for version in versions %}
                <tr class="{% if version.active %}table-success{% endif %}">
                  <td>
                    <span class="badge bg-{{ version.status_badge_class }}">
                      {{ version.version_display }}
                    </span>
                    {% if version.active %}
                      <span class="badge bg-success ms-1">Attiva</span>
                    {% endif %}
                  </td>
                  <td>{{ version.uploaded_by }}</td>
                  <td>{{ version.timestamp.strftime('%d/%m/%Y %H:%M') }}</td>
                  <td>
                    {% if version.note %}
                      {{ version.note }}
                    {% else %}
                      <span class="text-muted">-</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if version.ai_diff_summary %}
                      <span class="badge bg-info text-dark" 
                            title="{{ version.ai_diff_summary }}">
                        üß† AI
                      </span>
                      <small class="d-block text-muted mt-1">
                        {{ version.ai_summary_short }}
                      </small>
                    {% else %}
                      <span class="text-muted">-</span>
                    {% endif %}
                  </td>
                  <td>
                    <div class="btn-group btn-group-sm" role="group">
                      <a href="{{ url_for('static', filename=version.file_path) }}" 
                         class="btn btn-outline-primary" title="Scarica Versione">
                        <i class="fas fa-download"></i>
                      </a>
                      
                      {% if not version.active %}
                        <form method="POST" action="{{ url_for('docs.restore_version', version_id=version.id) }}" 
                              style="display:inline;" 
                              onsubmit="return confirm('Sei sicuro di voler ripristinare questa versione?')">
                          <button type="submit" class="btn btn-warning" title="Ripristina Versione">
                            <i class="fas fa-undo"></i>
                          </button>
                        </form>
                      {% else %}
                        <span class="badge bg-success">Attiva</span>
                      {% endif %}
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            Nessuna versione disponibile per questo documento.
          </div>
        {% endif %}
      </div>
    </div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Tooltip per i badge AI
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'))
  var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl)
  })
</script>

</body>
</html>